# Make Mirai Cluster

`make_cluster` creates a cluster of type 'miraiCluster', which may be
used as a cluster object for any function in the parallel base package
such as
[`parallel::clusterApply()`](https://rdrr.io/r/parallel/clusterApply.html)
or
[`parallel::parLapply()`](https://rdrr.io/r/parallel/clusterApply.html).

`stop_cluster` stops a cluster created by `make_cluster`.

## Usage

``` r
make_cluster(n, url = NULL, remote = NULL, ...)

stop_cluster(cl)
```

## Arguments

- n:

  integer number of nodes (automatically launched on the local machine
  unless `url` is supplied).

- url:

  (specify for remote nodes) the character URL on the host for remote
  nodes to dial into, including a port accepting incoming connections,
  e.g. 'tcp://10.75.37.40:5555'. Specify a URL with the scheme
  'tls+tcp://' to use secure TLS connections.

- remote:

  (specify to launch remote nodes) a remote launch configuration
  generated by
  [`ssh_config()`](https://mirai.r-lib.org/dev/reference/ssh_config.md),
  [`cluster_config()`](https://mirai.r-lib.org/dev/reference/cluster_config.md)
  or
  [`remote_config()`](https://mirai.r-lib.org/dev/reference/remote_config.md).
  If not supplied, nodes may be deployed manually on remote resources.

- ...:

  additional arguments passed to
  [`daemons()`](https://mirai.r-lib.org/dev/reference/daemons.md).

- cl:

  a 'miraiCluster'.

## Value

For **make_cluster**: An object of class 'miraiCluster' and 'cluster'.
Each 'miraiCluster' has an automatically assigned ID and `n` nodes of
class 'miraiNode'. If `url` is supplied but not `remote`, the shell
commands for deployment of nodes on remote resources are printed to the
console.

For **stop_cluster**: invisible NULL.

## Details

For R version 4.5 or newer,
[`parallel::makeCluster()`](https://rdrr.io/r/parallel/makeCluster.html)
specifying `type = "MIRAI"` is equivalent to this function.

## Note

The default behaviour of clusters created by this function is designed
to map as closely as possible to clusters created by the parallel
package. However, `...` arguments are passed onto
[`daemons()`](https://mirai.r-lib.org/dev/reference/daemons.md) for
additional customisation if desired, although resultant behaviour may
not always be supported.

## Remote Nodes

Specify `url` and `n` to set up a host connection for remote nodes to
dial into. `n` defaults to one if not specified.

Also specify `remote` to launch the nodes using a configuration
generated by
[`remote_config()`](https://mirai.r-lib.org/dev/reference/remote_config.md)
or
[`ssh_config()`](https://mirai.r-lib.org/dev/reference/ssh_config.md).
In this case, the number of nodes is inferred from the configuration
provided and `n` is disregarded.

If `remote` is not supplied, the shell commands for deploying nodes
manually on remote resources are automatically printed to the console.

[`launch_remote()`](https://mirai.r-lib.org/dev/reference/launch_local.md)
may be called at any time on a 'miraiCluster' to return the shell
commands for deployment of all nodes, or on a 'miraiNode' to return the
command for a single node.

## Status

Call [`status()`](https://mirai.r-lib.org/dev/reference/status.md) on a
'miraiCluster' to check the number of currently active connections as
well as the host URL.

## Errors

Errors are thrown by the parallel package mechanism if one or more nodes
failed (quit unexpectedly). The resulting 'errorValue' returned is 19
(Connection reset). Other types of error, e.g. in evaluation, result in
the usual 'miraiError' being returned.

## Examples

``` r
if (FALSE) { # interactive()
cl <- make_cluster(2)
cl
cl[[1L]]

Sys.sleep(0.5)
status(cl)

stop_cluster(cl)
}
```
