<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Community FAQs • mirai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Community FAQs">
<meta name="robots" content="noindex">
<script defer data-domain="mirai.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mirai</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.4.1.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mirai.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01-map.html">Mirai Map</a></li>
    <li><a class="dropdown-item" href="../articles/v02-promises.html">Promises - Shiny and Plumber</a></li>
    <li><a class="dropdown-item" href="../articles/v03-serialization.html">Serialization - Arrow, ADBC, polars, torch</a></li>
    <li><a class="dropdown-item" href="../articles/v04-parallel.html">Communications Backend for R</a></li>
    <li><a class="dropdown-item" href="../articles/v05-packages.html">For Package Authors</a></li>
    <li><a class="dropdown-item" href="../articles/v06-questions.html">Community FAQs</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://shikokuchuo.net/posts/27-mirai-240/">mirai 2.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://shikokuchuo.net/posts/26-mirai-230/">mirai 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://shikokuchuo.net/posts/25-mirai-v2/">mirai 2.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/mirai/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Community FAQs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/mirai/blob/main/vignettes/v06-questions.Rmd" class="external-link"><code>vignettes/v06-questions.Rmd</code></a></small>
      <div class="d-none name"><code>v06-questions.Rmd</code></div>
    </div>

    
    
<p>This vignette is designed to provide a knowledgebase for questions
posed by the community, and will be added to over time.</p>
<div class="section level3">
<h3 id="migration-from-future_promise">1. Migration from <code>future_promise()</code><a class="anchor" aria-label="anchor" href="#migration-from-future_promise"></a>
</h3>
<p>For use within Shiny, it should be straightforward translating
ExtendedTask or other async code that was originally written for use
with a <code><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">promises::future_promise()</a></code>.</p>
<p>Note: <code><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">future_promise()</a></code> exists in the promises package as
we had to find a workaround to make <code>future(...)</code> always
async. <code>future(...)</code> by itself is not always async as it
blocks as soon as it runs out of parallel processes on which to run
tasks.</p>
<p><code><a href="../reference/mirai.html">mirai()</a></code> on the other hand is built as an async
framework, so there’s no need for an additional function from the
promises package. You should simply use a <code><a href="../reference/mirai.html">mirai()</a></code> directly
in place of a <code><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">future_promise()</a></code>.</p>
<p><strong>Globals:</strong></p>
<p>One important difference is that a <code><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">future_promise()</a></code> by
default tries to infer all the global variables that are required by the
expression. If your code depended on this convenience feature then you
will need to instead pass these in via the <code>...</code> of
<code><a href="../reference/mirai.html">mirai()</a></code>. A mirai requires that the expression be
self-contained, with any variables or helper functions explicitly
supplied to it.</p>
<p>On the other hand, if your code previously used the
<code>globals</code> argument to supply these variables, then you can
often pass that directly to the <code>.args</code> of
<code><a href="../reference/mirai.html">mirai()</a></code>. Note that this would only work in the case of a
named list and not the other forms that <code>globals</code> can
take.</p>
<p>Regardless of using a <code><a href="../reference/mirai.html">mirai()</a></code> or
<code><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">future_promise()</a></code>, we recommend that you pass globals
explicitly in production code. This is as globals detection is never
100% perfect, and there is always some element of guesswork. Edge cases
can lead to unpredictable failures or silently incorrect results.
Explicit passing of variables allows for transparent and reliable
behaviour, that remains completely robust over time.</p>
<p><strong>Capture globals using
<code><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment()</a></code>:</strong></p>
<p><code><a href="../reference/mirai.html">mirai()</a></code> allows passing an environment to
<code>...</code> or to <code>.args</code>. This is especially useful for
Shiny ExtendedTask, where it is invoked with a set of arguments. By
using <code>mirai::mirai({...}, environment())</code> you automatically
capture the variables provided to the invoke method. See the Shiny
vignette for example usage.</p>
<p><strong>Special Case: <code>...</code>:</strong></p>
<p>A Shiny app may have used <code><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">future_promise()</a></code> code similar
to the following within the server component:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">task</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/shiny/man/ExtendedTask.html" class="external-link">ExtendedTask</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rstudio.github.io/promises/reference/future_promise.html" class="external-link">future_promise</a></span><span class="op">(</span><span class="fu">func</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bind_task_button.html" class="external-link">bind_task_button</a></span><span class="op">(</span><span class="st">"btn"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">btn</span>, <span class="va">task</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">delay</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The equivalent in <code><a href="../reference/mirai.html">mirai()</a></code> is achieved by:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/shiny/man/ExtendedTask.html" class="external-link">ExtendedTask</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">func</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>, func <span class="op">=</span> <span class="va">func</span>, .args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bind_task_button.html" class="external-link">bind_task_button</a></span><span class="op">(</span><span class="st">"btn"</span><span class="op">)</span></span></code></pre></div>
<p>Note that here <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment()</a></code> captures the
<code>...</code> that’s then used within the mirai expression.</p>
</div>
<div class="section level3">
<h3 id="setting-the-random-seed">2. Setting the random seed<a class="anchor" aria-label="anchor" href="#setting-the-random-seed"></a>
</h3>
<p>The following example was raised as being potentially
counter-intuitive, given that default ‘cleanup’ settings at each daemon
ensures that variables in the global environment, of which
<code>.Random.seed</code> is one, do not carry over to subsequent
runs.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vec</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="va">vec2</span> <span class="op">&lt;-</span> <span class="fl">4</span><span class="op">:</span><span class="fl">6</span></span>
<span></span>
<span><span class="co"># Returns different values: good</span></span>
<span><span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vec</span>, <span class="va">vec2</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 0.2112876 0.9041800 0.7834014</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] -0.3150949 -1.5628536 -0.3860887</span></span>
<span></span>
<span><span class="co"># Set the seed in the function</span></span>
<span><span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vec</span>, <span class="va">vec2</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] -0.9685927  0.7061091  1.4890213</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] -0.9685927  0.7061091  1.4890213</span></span>
<span></span>
<span><span class="co"># Do not set the seed in the function: still identical results?</span></span>
<span><span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">vec</span>, <span class="va">vec2</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] -1.8150926  0.3304096 -1.1421557</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] -1.8150926  0.3304096 -1.1421557</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>The reason the change in random seed persists in all circumstances is
due to this being a special case, arising from the use of L’Ecuyer CMRG
streams to provide parallel-safe random numbers.</p>
<p>Streams can be thought of as entry points to the psuedo random number
line far away from each other to ensure that random results in each
daemon are independent from one another. The random seed is not reset
after each mirai call to ensure that however many random draws are made
in any mirai call, the next random draw follows on in the stream, and
hence have the desired statistical properties.</p>
<p>Hence normally, the random seed should be set once on the host
process when daemons are created, rather than in each daemon.</p>
<p>If it is required to set the seed in each daemon, this should be done
using an independent method and set each time random draws are required.
Another option would be to set the random seed within a local execution
scope to prevent the global random seed on each daemon from being
affected.</p>
</div>
<div class="section level3">
<h3 id="accessing-package-functions-during-development">3. Accessing package functions during development<a class="anchor" aria-label="anchor" href="#accessing-package-functions-during-development"></a>
</h3>
<p>A mirai call usually requires package-namespaced functions. However
the latest version of a package in development is often loaded
dynamically by <code>devtools::load_all()</code> or the underlying
<code><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">pkgload::load_all()</a></code> for quick iteration.</p>
<p>In this case, use <code><a href="../reference/everywhere.html">everywhere()</a></code> to also call
<code>devtools::load_all()</code> on all (local) daemons. They will then
have access to the same functions as your host session for subsequent
<code><a href="../reference/mirai.html">mirai()</a></code> calls.</p>
</div>
<div class="section level3">
<h3 id="why-does-it-take-time-for-mirai-to-execute-when-its-meant-to-return-immediately">4. Why does it take time for <code>mirai()</code> to execute when
it’s meant to return immediately?<a class="anchor" aria-label="anchor" href="#why-does-it-take-time-for-mirai-to-execute-when-its-meant-to-return-immediately"></a>
</h3>
<p>A <code><a href="../reference/mirai.html">mirai()</a></code> call is meant to return almost
instantaneously. The same when invoked by a Shiny
<code>ExtendedTask</code>. The only reason it would take time is if you
are passing through large objects, which then need to be serialized to
be sent to the parallel process.</p>
<p>Care should be taken when you pass a function or environment to
<code><a href="../reference/mirai.html">mirai()</a></code> in the <code>...</code> or <code>.args</code>
arguments. This is as a function includes its closure (enclosing
environment), and an environment its parent environments. This means you
could be passing more than you bargained for.</p>
<p>Generally, <code>obj_size()</code> from the lobstr package is a great
function for checking the actual size of an object (capturing many cases
more accurately than the base R <code>object.size</code>).</p>
<p>As mitigation for accidentally passing large objects:</p>
<ul>
<li>For functions, use <code>crate()</code> from the carrier package.
This is what we use in purrr, and it makes sure only what’s necessary is
‘crated’ with the function.</li>
<li>For environments, consider using
<code>parent.env(e) &lt;- emptyenv()</code>. This is not required for R6
classes as they are already isolated by default. Regardless of any
parent environment, an environment / R6 class could still contain a lot
of items that are not needed for the parallel process, in which case
consider passing individual members rather than the entire object.</li>
</ul>
<p>mirai does not rely on options or environment variables at all, so
there are no object size limits to set.</p>
<p>This follows mirai’s philosophy of being an enabler to widen the
possibility frontier for R code, but it does place a responsibility on
the user to ensure that the code is sensible and does what is
desired.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Charlie Gao, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
