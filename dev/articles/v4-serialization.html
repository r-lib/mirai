<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4. Serialization - Arrow, ADBC, polars, torch • mirai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="4. Serialization - Arrow, ADBC, polars, torch">
<meta name="robots" content="noindex">
<script defer data-domain="mirai.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mirai</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mirai.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v1-daemons.html">1. Daemons</a></li>
    <li><a class="dropdown-item" href="../articles/v2-map.html">2. Async Parallel Map</a></li>
    <li><a class="dropdown-item" href="../articles/v3-promises.html">3. Promises - Shiny and Plumber</a></li>
    <li><a class="dropdown-item" href="../articles/v4-serialization.html">4. Serialization - Arrow, ADBC, polars, torch</a></li>
    <li><a class="dropdown-item" href="../articles/v5-parallel.html">5. Mirai Clusters - Base R</a></li>
    <li><a class="dropdown-item" href="../articles/v6-packages.html">6. Guidance for Package Authors</a></li>
    <li><a class="dropdown-item" href="../articles/v7-community.html">7. Community FAQs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/mirai/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>4. Serialization - Arrow, ADBC, polars, torch</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/mirai/blob/main/vignettes/v4-serialization.Rmd" class="external-link"><code>vignettes/v4-serialization.Rmd</code></a></small>
      <div class="d-none name"><code>v4-serialization.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h3>
<ol style="list-style-type: decimal">
<li><a href="#serialization-arrow-polars-and-beyond">Serialization:
Arrow, polars and beyond</a></li>
<li><a href="#serialization-torch">Serialization: Torch</a></li>
<li><a href="#database-hosting-using-arrow-database-connectivity">Database
Hosting using Arrow Database Connectivity</a></li>
<li><a href="#shiny-mirai-dbi-adbc-integrated-example">Shiny / mirai /
DBI / ADBC Integrated Example</a></li>
</ol>
</div>
<div class="section level3">
<h3 id="serialization-arrow-polars-and-beyond">Serialization: Arrow, polars and beyond<a class="anchor" aria-label="anchor" href="#serialization-arrow-polars-and-beyond"></a>
</h3>
<p>Native R serialization is used for sending data between host and
daemons. Some R objects by their nature cannot be serialized, such as
those accessed via an external pointer. In these cases, performing
‘mirai’ operations on them would normally error.</p>
<p>Using the <a href="https://arrow.apache.org/docs/r/" class="external-link"><code>arrow</code></a> package
as an example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">as_arrow_table</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error: Invalid &lt;Table&gt;, external pointer to null</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>However, <code><a href="../reference/serial_config.html">serial_config()</a></code> can be used to create custom
serialization configurations, specifying functions that hook into R’s
native serialization mechanism for reference objects (‘refhooks’).</p>
<p>This configuration may then be passed to the ‘serial’ argument of a
<code><a href="../reference/daemons.html">daemons()</a></code> call.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  <span class="st">"ArrowTabular"</span>,</span>
<span>  <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 6 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;dictionary&lt;values=string, indices=int8&gt;&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See $metadata for additional Schema metadata</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "some text"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>It can be seen that this time, the arrow table is seamlessly handled
in the ‘mirai’ process. This is the case even when the object is deeply
nested inside lists or other structures.</p>
<p>Multiple serialization functions may be registered to handle
different object classes. As an example, we can use Arrow in combination
with <a href="https://pola-rs.github.io/r-polars/" class="external-link"><code>polars</code></a>, a
‘lightning fast’ dataframe library written in Rust (requires
<code>polars</code> &gt;= 0.16.4), in the following way:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  serial <span class="op">=</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ArrowTabular"</span>, <span class="st">"RPolarsDataFrame"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">polars</span><span class="fu">::</span><span class="fu">as_polars_df</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="fu">to_raw_ipc</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu">polars</span><span class="fu">::</span><span class="va">pl</span><span class="op">$</span><span class="va">read_ipc</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">polars</span><span class="fu">::</span><span class="fu">as_polars_df</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; shape: (6, 5)</span></span>
<span><span class="co">#&gt; ┌──────────────┬─────────────┬──────────────┬─────────────┬─────────┐</span></span>
<span><span class="co">#&gt; │ Sepal.Length ┆ Sepal.Width ┆ Petal.Length ┆ Petal.Width ┆ Species │</span></span>
<span><span class="co">#&gt; │ ---          ┆ ---         ┆ ---          ┆ ---         ┆ ---     │</span></span>
<span><span class="co">#&gt; │ f64          ┆ f64         ┆ f64          ┆ f64         ┆ cat     │</span></span>
<span><span class="co">#&gt; ╞══════════════╪═════════════╪══════════════╪═════════════╪═════════╡</span></span>
<span><span class="co">#&gt; │ 5.1          ┆ 3.5         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.9          ┆ 3.0         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.7          ┆ 3.2         ┆ 1.3          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.6          ┆ 3.1         ┆ 1.5          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 5.0          ┆ 3.6         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 5.4          ┆ 3.9         ┆ 1.7          ┆ 0.4         ┆ setosa  │</span></span>
<span><span class="co">#&gt; └──────────────┴─────────────┴──────────────┴─────────────┴─────────┘</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "some text"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="serialization-torch">Serialization: Torch<a class="anchor" aria-label="anchor" href="#serialization-torch"></a>
</h3>
<p>Tensors from the <a href="https://torch.mlverse.org/" class="external-link"><code>torch</code></a> package may be
used seamlessly in ‘mirai’ computations.</p>
<div class="section level4">
<h4 id="setup-steps">Setup Steps<a class="anchor" aria-label="anchor" href="#setup-steps"></a>
</h4>
<ol style="list-style-type: decimal">
<li>Create the serialization configuration, specifying ‘class’ as
‘torch_tensor’.</li>
<li>Set up daemons, supplying the configuration to the ‘serial’
argument.</li>
<li>(Optional) Use <code><a href="../reference/everywhere.html">everywhere()</a></code> to make the
<code>torch</code> package available on all daemons for
convenience.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"torch_tensor"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va">torch_serialize</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va">torch_load</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-usage">Example Usage<a class="anchor" aria-label="anchor" href="#example-usage"></a>
</h4>
<p>The below example creates a convolutional neural network using
<code>torch::nn_module()</code>.</p>
<p>A set of model parameters is also specified.</p>
<p>The model specification and parameters are then passed to and
initialized within a ‘mirai’.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">nn_module</span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv1</span> <span class="op">&lt;-</span> <span class="fu">nn_conv2d</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv2</span> <span class="op">&lt;-</span> <span class="fu">nn_conv2d</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">nnf_relu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">nnf_relu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>in_size <span class="op">=</span> <span class="fl">1</span>, out_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span><span class="op">)</span>, model <span class="op">=</span> <span class="va">model</span>, params <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; An `nn_module` containing 1,040 parameters.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Modules ────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • conv1: &lt;nn_conv2d&gt; #520 parameters</span></span>
<span><span class="co">#&gt; • conv2: &lt;nn_conv2d&gt; #520 parameters</span></span></code></pre></div>
<p>The returned model is an object containing many tensor elements.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">conv1.weight</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; (1,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.0593 -0.1724 -0.1015  0.0721  0.1870</span></span>
<span><span class="co">#&gt;  -0.0696 -0.0069  0.1750 -0.1473 -0.1115</span></span>
<span><span class="co">#&gt;  -0.1094 -0.0244 -0.0372 -0.1030  0.0769</span></span>
<span><span class="co">#&gt;  -0.1097 -0.1982  0.0095  0.1654 -0.1593</span></span>
<span><span class="co">#&gt;   0.1083  0.0996 -0.0691  0.0559  0.0419</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (2,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.1889 -0.0101  0.1209 -0.0144 -0.0188</span></span>
<span><span class="co">#&gt;  -0.0368 -0.0312  0.1282  0.0403  0.1658</span></span>
<span><span class="co">#&gt;  -0.1583 -0.0868 -0.1853  0.1314  0.0121</span></span>
<span><span class="co">#&gt;  -0.1384  0.0029 -0.1645 -0.1048 -0.0134</span></span>
<span><span class="co">#&gt;  -0.0158  0.1582  0.0696  0.0152  0.1638</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (3,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.1573  0.1069 -0.0208 -0.0344 -0.1840</span></span>
<span><span class="co">#&gt;   0.0684  0.1507 -0.0184 -0.1686 -0.0571</span></span>
<span><span class="co">#&gt;  -0.0309  0.0351  0.0203  0.1085 -0.0680</span></span>
<span><span class="co">#&gt;  -0.0452 -0.1689  0.0026  0.1814  0.0202</span></span>
<span><span class="co">#&gt;  -0.0468  0.0591 -0.1217  0.0770 -0.1620</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (4,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.1639 -0.1043 -0.0118 -0.1168  0.0185</span></span>
<span><span class="co">#&gt;   0.1516  0.0036  0.1087  0.1270 -0.0555</span></span>
<span><span class="co">#&gt;   0.1294 -0.1414 -0.1717 -0.0662 -0.0857</span></span>
<span><span class="co">#&gt;  -0.0292  0.1971 -0.1249  0.1466 -0.1288</span></span>
<span><span class="co">#&gt;  -0.1209  0.0194  0.0973 -0.0057 -0.0028</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (5,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.0569 -0.0060 -0.0993 -0.0552 -0.0605</span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{20,1,5,5} ][ requires_grad = TRUE ]</span></span></code></pre></div>
<p>It is usual for model parameters to then be passed to an
optimiser.</p>
<p>This can also be initialized within a ‘mirai’ process.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">optim_rmsprop</span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span><span class="op">)</span>, params <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optim</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;optim_rmsprop&gt;</span></span>
<span><span class="co">#&gt;   Inherits from: &lt;torch_optimizer&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     add_param_group: function (param_group) </span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     defaults: list</span></span>
<span><span class="co">#&gt;     initialize: function (params, lr = 0.01, alpha = 0.99, eps = 1e-08, weight_decay = 0, </span></span>
<span><span class="co">#&gt;     load_state_dict: function (state_dict, ..., .refer_to_state_dict = FALSE) </span></span>
<span><span class="co">#&gt;     param_groups: list</span></span>
<span><span class="co">#&gt;     state: State, R6</span></span>
<span><span class="co">#&gt;     state_dict: function () </span></span>
<span><span class="co">#&gt;     step: function (closure = NULL) </span></span>
<span><span class="co">#&gt;     zero_grad: function (set_to_none = FALSE) </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     deep_clone: function (name, value) </span></span>
<span><span class="co">#&gt;     step_helper: function (closure, loop_fun)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Above, tensors and complex objects containing tensors were passed
seamlessly between host and daemon processes, in the same way as any
other R object.</p>
<p>The custom serialization in <code>mirai</code> leverages R’s own
native ‘refhook’ mechanism to allow such completely transparent usage.
Designed to be fast and efficient, data copies are minimised and the
‘official’ serialization methods from the <code>torch</code> package are
used directly.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="database-hosting-using-arrow-database-connectivity">Database Hosting using Arrow Database Connectivity<a class="anchor" aria-label="anchor" href="#database-hosting-using-arrow-database-connectivity"></a>
</h3>
<p>It is possible using the <code>DBI</code> interface to access and
manipulate data in the Apache Arrow data format efficiently through ABDC
(Arrow Database Connectivity).</p>
<p>The example below creates an in-memory SQLite connection using the
<code>adbcsqlite</code> backend.</p>
<p>Serialization is set up with the relevant serialization functions
from the <code>arrow</code> package as part of the
<code><a href="../reference/daemons.html">daemons()</a></code> call. Note that the specified class is
‘nanoarrow_array_stream’ as <code>nanoarrow</code> is the backend for
all queries made by the DBI <code>db*Arrow()</code> functions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"nanoarrow_array_stream"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span> <span class="co"># `adbi` and `adbcsqlite` packages must also be installed</span></span>
<span>    <span class="va">con</span> <span class="op">&lt;&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">adbi</span><span class="fu">::</span><span class="fu">adbi</span><span class="op">(</span><span class="st">"adbcsqlite"</span><span class="op">)</span>, uri <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/mirai.html">mirai()</a></code> calls may then be used to write to or query the
database all in the Arrow format.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">dbWriteTableArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span>, <span class="va">iris</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbWriteTableArrow': object 'con' not found</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">dbReadTableArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbReadTableArrow': object 'con' not found</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Sepal.Length" &lt; 4.6'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbGetQueryArrow': object 'con' not found</span></span></code></pre></div>
<p>Due to the tight integration of the <code>mirai</code> serialization
mechanism with R’s ‘refhook’ system, we can easily return complex /
nested objects containing multiple queries in the Arrow format:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Sepal.Length" &lt; 4.6'</span><span class="op">)</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Sepal.Width" &lt; 2.6'</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Petal.Length" &lt; 1.5'</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Petal.Width" &lt; 0.2'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sepal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">a</span>, width <span class="op">=</span> <span class="va">b</span><span class="op">)</span>, petal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">x</span>, width <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbGetQueryArrow': object 'con' not found</span></span></code></pre></div>
<p>As before, <code><a href="../reference/everywhere.html">everywhere()</a></code> can be used again to cleanly
tear down the databases, before resetting daemons.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="shiny-mirai-dbi-adbc-integrated-example">Shiny / mirai / DBI / ADBC Integrated Example<a class="anchor" aria-label="anchor" href="#shiny-mirai-dbi-adbc-integrated-example"></a>
</h3>
<p>The following is an example of how database connections hosted in
mirai daemons may be used to power a Shiny app.</p>
<p>The one-time <code>serialization()</code> setup ensures seamless
transport of Apache Arrow data, and occurs in the global environment
outside of <code>server()</code>.</p>
<p>A new database connection is created in a new daemon process for
every new Shiny session. The resources are freed when a sesssion ends.
This logic is all defined within <code>server()</code>. A unique ID is
used to identify each session, and is specified as the ‘compute profile’
for daemons.</p>
<p>Non-dispatcher daemons are created as scheduling is not required (all
queries expected to take roughly the same time, and in this case each
session uses only one daemon anyway).</p>
<p>Shiny ExtendedTask is then used to perform each query via a
<code><a href="../reference/mirai.html">mirai()</a></code> call, using the session-specific compute
profile.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shikokuchuo.net/secretbase/" class="external-link">secretbase</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/bslib/" class="external-link">bslib</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create an Arrow serialization configuration</span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"nanoarrow_array_stream"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="fu">nanoarrow</span><span class="fu">::</span><span class="va">read_nanoarrow</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># write 'iris' dataset to temp database file (for this demonstration)</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">adbi</span><span class="fu">::</span><span class="fu">adbi</span><span class="op">(</span><span class="st">"adbcsqlite"</span><span class="op">)</span>, uri <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbWriteTableArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span>, <span class="va">iris</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># common input parameters</span></span>
<span><span class="va">slmin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span></span>
<span><span class="va">slmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/page.html" class="external-link">page_fluid</a></span><span class="op">(</span></span>
<span>  <span class="fu">p</span><span class="op">(</span><span class="st">"The time is "</span>, <span class="fu">textOutput</span><span class="op">(</span><span class="st">"current_time"</span>, inline <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">hr</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">h3</span><span class="op">(</span><span class="st">"Shiny / mirai / DBI / ADBC demonstration"</span><span class="op">)</span>,</span>
<span>  <span class="fu">p</span><span class="op">(</span><span class="st">"New daemon-hosted database connection is created for every Shiny session"</span><span class="op">)</span>,</span>
<span>  <span class="fu">sliderInput</span><span class="op">(</span></span>
<span>    <span class="st">"sl"</span>, <span class="st">"Query iris dataset based on Sepal Length"</span>, min <span class="op">=</span> <span class="va">slmin</span>, max <span class="op">=</span> <span class="va">slmax</span>,</span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">slmin</span>, <span class="va">slmax</span><span class="op">)</span>, width <span class="op">=</span> <span class="st">"75%"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/bslib/reference/input_task_button.html" class="external-link">input_task_button</a></span><span class="op">(</span><span class="st">"btn"</span>, <span class="st">"Return query"</span><span class="op">)</span>,</span>
<span>  <span class="fu">tableOutput</span><span class="op">(</span><span class="st">"table"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># uses Shiny ExtendedTask with mirai</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># create unique session id by hashing current time with a random key</span></span>
<span>  <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu">secretbase</span><span class="fu">::</span><span class="fu">siphash13</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, key <span class="op">=</span> <span class="fu">nanonext</span><span class="fu">::</span><span class="fu"><a href="https://nanonext.r-lib.org/reference/random.html" class="external-link">random</a></span><span class="op">(</span><span class="fl">4L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># create new daemon for each session</span></span>
<span>  <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1L</span>, serial <span class="op">=</span> <span class="va">cfg</span>, .compute <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># tear down daemon when session ends</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="fu">onEnded</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0L</span>, .compute <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># everywhere() loads DBI and creates ADBC connection in each daemon</span></span>
<span>  <span class="co"># and sets up serialization</span></span>
<span>  <span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span> <span class="co"># `adbi` and `adbcsqlite` packages must also be installed</span></span>
<span>      <span class="va">con</span> <span class="op">&lt;&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">adbi</span><span class="fu">::</span><span class="fu">adbi</span><span class="op">(</span><span class="st">"adbcsqlite"</span><span class="op">)</span>, uri <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    file <span class="op">=</span> <span class="va">file</span>,</span>
<span>    .compute <span class="op">=</span> <span class="va">id</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">invalidateLater</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%H:%M:%S %p"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">task</span> <span class="op">&lt;-</span> <span class="va">ExtendedTask</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span></span>
<span>      <span class="fu">dbGetQueryArrow</span><span class="op">(</span></span>
<span>        <span class="va">con</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>          <span class="st">"SELECT * FROM iris WHERE \"Sepal.Length\" BETWEEN %.2f AND %.2f"</span>,</span>
<span>          <span class="va">sl</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span>,</span>
<span>          <span class="va">sl</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="va">...</span>,</span>
<span>      .compute <span class="op">=</span> <span class="va">id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bind_task_button.html" class="external-link">bind_task_button</a></span><span class="op">(</span><span class="st">"btn"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">btn</span>, <span class="va">task</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span>sl <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">sl</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu">renderTable</span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">result</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># run Shiny app</span></span>
<span><span class="fu">shinyApp</span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># deletes temp database file (for this demonstration)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Charlie Gao, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

  </div></footer>
</body>
</html>
