---
title: "mirai - Communications Backend for R"
vignette: >
  %\VignetteIndexEntry{mirai - Communications Backend for R}
  %\VignetteEngine{litedown::vignette}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

### 1. Mirai Parallel Clusters

mirai provides an alternative communications backend for R, developed to fulfill an R Core request at R Project Sprint 2023.

'miraiCluster' is an official cluster type in R 4.5, created via `parallel::makeCluster(type = "MIRAI")`. This calls `make_cluster()`, which can also create 'miraiCluster' directly.

  + Specify 'n' to launch local nodes
  + Specify 'url' to receive remote node connections
  + Optionally specify 'remote' to launch remote daemons using configurations from `ssh_config()`, `cluster_config()` or `remote_config()`

Use clusters with any `parallel` package function (`clusterApply()`, `parLapply()`, `parLapplyLB()`, etc.):
```{r}
#| label: cluster
library(parallel)
library(mirai)

cl <- makeCluster(6, type = "MIRAI")
cl
parLapply(cl, iris, mean)
```
```{r}
#| label: sleep
#| echo: false
Sys.sleep(1L)
```

Call `status()` on a 'miraiCluster' to query connected nodes:
```{r}
#| label: cluster2
status(cl)
stopCluster(cl)
```

Specifying 'url' without 'remote' prints shell commands for manual node deployment:
```{r}
#| label: cluster3
cl <- make_cluster(n = 2, url = host_url())
stop_cluster(cl)
```

### 2. Foreach Support

Register 'miraiCluster' with [`doParallel`](https://cran.r-project.org/package=doParallel) for use with [`foreach`](https://cran.r-project.org/package=foreach).

Parallel `foreach()` examples:

```{r}
#| label: foreach
library(doParallel)
library(foreach)

cl <- makeCluster(6, type = "MIRAI")
registerDoParallel(cl)

# normalize the rows of a matrix
m <- matrix(rnorm(9), 3, 3)
foreach(i = 1:nrow(m), .combine = rbind) %dopar%
  (m[i, ] / mean(m[i, ]))

# simple parallel matrix multiply
a <- matrix(1:16, 4, 4)
b <- t(a)
foreach(b = iterators::iter(b, by='col'), .combine = cbind) %dopar%
  (a %*% b)

stopCluster(cl)
```
