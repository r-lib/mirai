<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>mirai - Minimalist Async Evaluation Framework for R • mirai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="mirai - Minimalist Async Evaluation Framework for R">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mirai</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/mirai.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/databases.html">mirai - Databases and Arrow</a></li>
    <li><a class="dropdown-item" href="../articles/parallel.html">mirai - Parallel Integration</a></li>
    <li><a class="dropdown-item" href="../articles/plumber.html">mirai - Plumber Integration</a></li>
    <li><a class="dropdown-item" href="../articles/promises.html">mirai - Promises Integration</a></li>
    <li><a class="dropdown-item" href="../articles/shiny.html">mirai - Shiny Integration</a></li>
    <li><a class="dropdown-item" href="../articles/torch.html">mirai - Torch Integration</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/shikokuchuo/mirai/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://shikokuchuo.net/" aria-label="shikokuchuo"><span class="fa fa-cube"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>mirai - Minimalist Async Evaluation Framework for R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shikokuchuo/mirai/blob/v2.2.0/vignettes/mirai.Rmd" class="external-link"><code>vignettes/mirai.Rmd</code></a></small>
      <div class="d-none name"><code>mirai.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h3>
<ol style="list-style-type: decimal">
<li><a href="#example-1-compute-intensive-operations">Example 1:
Compute-intensive Operations</a></li>
<li><a href="#example-2-io-bound-operations">Example 2: I/O-bound
Operations</a></li>
<li><a href="#example-3-resilient-pipelines">Example 3: Resilient
Pipelines</a></li>
<li><a href="#daemons-local-persistent-processes">Daemons: Local
Persistent Processes</a></li>
<li><a href="#distributed-computing-remote-daemons">Distributed
Computing: Remote Daemons</a></li>
<li><a href="#distributed-computing-launching-daemons">Distributed
Computing: Launching Daemons</a></li>
<li><a href="#distributed-computing-tls-secure-connections">Distributed
Computing: TLS Secure Connections</a></li>
<li><a href="#compute-profiles">Compute Profiles</a></li>
<li><a href="#errors-interrupts-and-timeouts">Errors, Interrupts and
Timeouts</a></li>
<li><a href="#serialization-arrow-polars-and-beyond">Serialization -
Arrow, polars and beyond</a></li>
<li><a href="#asynchronous-parallel-map">Asynchronous Parallel
Map</a></li>
<li><a href="#using-mirai-in-a-package">Using mirai in a
Package</a></li>
</ol>
</div>
<div class="section level3">
<h3 id="example-1-compute-intensive-operations">Example 1: Compute-intensive Operations<a class="anchor" aria-label="anchor" href="#example-1-compute-intensive-operations"></a>
</h3>
<p>Use case: minimise execution times by performing long-running tasks
concurrently in separate processes.</p>
<p>Multiple long computes (model fits etc.) can be performed in parallel
on available computing cores.</p>
<p>Use <code><a href="../reference/mirai.html">mirai()</a></code> to evaluate an expression asynchronously in
a separate, clean R process.</p>
<p>The following mimics an expensive calculation that eventually returns
a random value.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shikokuchuo.net/mirai/">mirai</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">2L</span>, mean <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="va">mean</span><span class="op">)</span><span class="op">}</span>, time <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">time</span>, mean <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<p>The mirai expression is evaluated in another process and hence must
be self-contained, not referring to variables that do not already exist
there. Above, the variables <code>time</code> and <code>mean</code> are
passed as part of the <code><a href="../reference/mirai.html">mirai()</a></code> call.</p>
<p>A ‘mirai’ object is returned immediately - creating a mirai never
blocks the session.</p>
<p>Whilst the async operation is ongoing, attempting to access a mirai’s
data yields an ‘unresolved’ logical NA.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span></span>
<span><span class="co">#&gt; &lt; mirai [] &gt;</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="co">#&gt; 'unresolved' logi NA</span></span></code></pre></div>
<p>To check whether a mirai remains unresolved (yet to complete):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/unresolved.html">unresolved</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>To wait for and collect the return value, use the mirai’s
<code>[]</code> method:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 2.048591 5.230767 3.294949 2.712959 3.619099</span></span></code></pre></div>
<p>As a mirai represents an async operation, it is never necessary to
wait for it - other code can continue to be run. Once it completes, the
return value automatically becomes available at <code>$data</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span></span>
<span><span class="co">#&gt; &lt; mirai [$data] &gt;</span></span>
<span><span class="va">m</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="co">#&gt; [1] 2.048591 5.230767 3.294949 2.712959 3.619099</span></span></code></pre></div>
<p>For easy programmatic use of <code><a href="../reference/mirai.html">mirai()</a></code>, ‘.expr’ accepts a
pre-constructed language object, and also a list of named arguments
passed via ‘.args’. So, the following would be equivalent to the
above:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5L</span>, <span class="va">mean</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">time</span>, mean <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span>.expr <span class="op">=</span> <span class="va">expr</span>, .args <span class="op">=</span> <span class="va">args</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 5.032453 3.540364 4.290378 3.400331 4.291239</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="example-2-io-bound-operations">Example 2: I/O-bound Operations<a class="anchor" aria-label="anchor" href="#example-2-io-bound-operations"></a>
</h3>
<p>Use case: ensure execution flow of the main process is not
blocked.</p>
<p>High-frequency real-time data cannot be written to file/database
synchronously without disrupting the execution flow.</p>
<p>Cache data in memory and use <code><a href="../reference/mirai.html">mirai()</a></code> to perform periodic
write operations concurrently in a separate process.</p>
<p>Below, ‘.args’ is used to pass <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment()</a></code>, which is
the calling environment. This provides a convenient method of passing in
existing objects.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shikokuchuo.net/mirai/">mirai</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">x</span>, file <span class="op">=</span> <span class="va">file</span><span class="op">)</span>, .args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A ‘mirai’ object is returned immediately.</p>
<p><code><a href="../reference/unresolved.html">unresolved()</a></code> may be used in control flow statements to
perform actions which depend on resolution of the ‘mirai’, both before
and after.</p>
<p>This means there is no need to actually wait (block) for a ‘mirai’ to
resolve, as the example below demonstrates.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># unresolved() queries for resolution itself so no need to use it again within the while loop</span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="../reference/unresolved.html">unresolved</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"while unresolved\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; while unresolved</span></span>
<span><span class="co">#&gt; while unresolved</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Write complete:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Write complete: TRUE</span></span></code></pre></div>
<p>Now actions which depend on the resolution may be processed, for
example the next write.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="example-3-resilient-pipelines">Example 3: Resilient Pipelines<a class="anchor" aria-label="anchor" href="#example-3-resilient-pipelines"></a>
</h3>
<p>Use case: isolating code that can potentially fail in a separate
process to ensure continued uptime.</p>
<p>As part of a data science / machine learning pipeline, iterations of
model training may periodically fail for stochastic and uncontrollable
reasons (e.g. buggy memory management on graphics cards).</p>
<p>Running each iteration in a ‘mirai’ isolates this
potentially-problematic code such that even if it does fail, it does not
bring down the entire pipeline.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shikokuchuo.net/mirai/">mirai</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_iteration</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"random error\n"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># simulates a stochastic error rate</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"iteration %d successful\n"</span>, <span class="va">i</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">run_iteration</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="../reference/is_mirai_error.html">is_error_value</a></span><span class="op">(</span><span class="fu"><a href="../reference/call_mirai.html">call_mirai</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">run_iteration</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; iteration 1 successful</span></span>
<span><span class="co">#&gt; iteration 2 successful</span></span>
<span><span class="co">#&gt; iteration 3 successful</span></span>
<span><span class="co">#&gt; iteration 4 successful</span></span>
<span><span class="co">#&gt; iteration 5 successful</span></span>
<span><span class="co">#&gt; iteration 6 successful</span></span>
<span><span class="co">#&gt; Error: random error</span></span>
<span><span class="co">#&gt; iteration 7 successful</span></span>
<span><span class="co">#&gt; iteration 8 successful</span></span>
<span><span class="co">#&gt; iteration 9 successful</span></span>
<span><span class="co">#&gt; iteration 10 successful</span></span></code></pre></div>
<p>Further, by testing the return value of each ‘mirai’ for errors,
error-handling code is then able to automate recovery and re-attempts,
as in the above example. Further details on <a href="#errors-interrupts-and-timeouts">error handling</a> can be found
in the section below.</p>
<p>The end result is a resilient and fault-tolerant pipeline that
minimises downtime by eliminating interruptions of long computes.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="daemons-local-persistent-processes">Daemons: Local Persistent Processes<a class="anchor" aria-label="anchor" href="#daemons-local-persistent-processes"></a>
</h3>
<p>Daemons, or persistent background processes, may be set to receive
‘mirai’ requests.</p>
<p>This is potentially more efficient as new processes no longer need to
be created on an <em>ad hoc</em> basis.</p>
<p>Daemons inherit the default system configuration and read in the
relevant ‘.Renviron’ and ‘.Rprofile’ etc. on startup. They also load the
default packages. To instead only load the <code>base</code> package
(which cuts out more than half of R’s startup time), the environment
variable <code>R_SCRIPT_DEFAULT_PACKAGES=NULL</code> may be set prior to
launching daemons.</p>
<div class="section level4">
<h4 id="with-dispatcher-default">With Dispatcher (default)<a class="anchor" aria-label="anchor" href="#with-dispatcher-default"></a>
</h4>
<p>Call <code><a href="../reference/daemons.html">daemons()</a></code> specifying the number of daemons to
launch.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>To view the current status, <code><a href="../reference/status.html">status()</a></code> provides the number
of active connections, the URL daemons connect to, and a named vector
showing the number of awaiting, executing and completed tasks: -
<code>waiting</code> number of tasks queued for execution at dispatcher
- <code>assigned</code> number of tasks sent to a daemon for execution -
<code>complete</code> number of tasks for which the result has been
received (either completed or cancelled)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $connections</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $daemons</span></span>
<span><span class="co">#&gt; [1] "abstract://0aee204536c706b2eb3db5c3"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mirai</span></span>
<span><span class="co">#&gt;  awaiting executing completed </span></span>
<span><span class="co">#&gt;         0         0         0</span></span></code></pre></div>
<p>The default <code>dispatcher = TRUE</code> creates a
<code><a href="../reference/dispatcher.html">dispatcher()</a></code> background process that connects to individual
daemon processes on the local machine. This ensures that tasks are
dispatched efficiently on a first-in first-out (FIFO) basis to daemons
for processing. Tasks are queued at dispatcher and sent to a daemon as
soon as it can accept the task for immediate execution.</p>
<p>Dispatcher uses synchronisation primitives from <a href="https://doi.org/10.5281/zenodo.7903429" class="external-link"><code>nanonext</code></a>,
waiting upon rather than polling at intervals for tasks, which is
efficient both in terms of consuming no resources while waiting, and
also being fully synchronised with events (having no latency).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Set the number of daemons to zero to reset. This reverts to the
default of creating a new background process for each ‘mirai’
request.</p>
</div>
<div class="section level4">
<h4 id="without-dispatcher">Without Dispatcher<a class="anchor" aria-label="anchor" href="#without-dispatcher"></a>
</h4>
<p>Alternatively, specifying <code>dispatcher = FALSE</code>, the
background daemons connect directly to the host process.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">6</span>, dispatcher <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>Requesting the status now shows 6 connections, along with the host
URL at <code>$daemons</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $connections</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $daemons</span></span>
<span><span class="co">#&gt; [1] "abstract://7356896b832fd118e6b571e0"</span></span></code></pre></div>
<p>This implementation sends tasks immediately, and ensures that tasks
are evenly-distributed amongst daemons. This means that optimal
scheduling is not guaranteed as the duration of tasks cannot be known
<em>a priori</em>. As an example, tasks could be queued at a daemon
behind a long-running task, whilst other daemons are idle having already
completed their tasks.</p>
<p>The advantage of this approach is that it is low-level and does not
require an additional dispatcher process. It is well-suited to working
with similar-length tasks, or where the number of concurrent tasks
typically does not exceed available daemons.</p>
</div>
<div class="section level4">
<h4 id="everywhere">Everywhere<a class="anchor" aria-label="anchor" href="#everywhere"></a>
</h4>
<p><code><a href="../reference/everywhere.html">everywhere()</a></code> may be used to evaluate an expression on
all connected daemons and persist the resultant state, regardless of a
daemon’s ‘cleanup’ setting.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The above keeps the <a href="https://dbi.r-dbi.org/" class="external-link"><code>DBI</code></a> package loaded for
all evaluations. Other types of setup task may also be performed,
including making a common resource available, such as a database
connection:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="va">con</span> <span class="op">&lt;&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">SQLite</span><span class="op">(</span><span class="op">)</span>, <span class="va">file</span><span class="op">)</span>, file <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span></code></pre></div>
<p>By super-assignment, the conenction ‘con’ will be available in the
global environment of all daemon instances. Subsequent mirai calls may
then make use of ‘con’.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "Formal class 'SQLiteConnection' [package \"RSQLite\"] with 8 slots" </span></span>
<span><span class="co">#&gt; [2] "  ..@ ptr                :&lt;externalptr&gt; "                           </span></span>
<span><span class="co">#&gt; [3] "  ..@ dbname             : chr \"/tmp/Rtmp38fyZ3/file90b8783c5d9c\""</span></span>
<span><span class="co">#&gt; [4] "  ..@ loadable.extensions: logi TRUE"                               </span></span>
<span><span class="co">#&gt; [5] "  ..@ flags              : int 70"                                  </span></span>
<span><span class="co">#&gt; [6] "  ..@ vfs                : chr \"\""                                </span></span>
<span><span class="co">#&gt; [7] "  ..@ ref                :&lt;environment: 0x57ecca241730&gt; "           </span></span>
<span><span class="co">#&gt; [8] "  ..@ bigint             : chr \"integer64\""                       </span></span>
<span><span class="co">#&gt; [9] "  ..@ extended_types     : logi FALSE"</span></span></code></pre></div>
<p>Disconnect from the database everywhere:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Sometimes it may be necessary to evaluate an expression in the global
environment of each daemon. As mirai evaluation does not occur in the
global environment itself, but one inheriting from it, an explicit call
to <code>evalq(envir = .GlobalEnv)</code> achieves this. An example use
case is <code>box::use()</code> to import a module or package:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">evalq</a></span><span class="op">(</span></span>
<span>    <span class="fu">box</span><span class="fu">::</span><span class="fu">use</span><span class="op">(</span><span class="va">dplyr</span><span class="op">[</span><span class="va">select</span><span class="op">]</span>, <span class="va">mirai</span><span class="op">[</span><span class="va">...</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    envir <span class="op">=</span> <span class="va">.GlobalEnv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="with-method">With Method<a class="anchor" aria-label="anchor" href="#with-method"></a>
</h4>
<p><code><a href="../reference/daemons.html">daemons()</a></code> has a <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> method, which
evaluates an expression with daemons created for the duration of the
expression and automatically torn down upon completion. It was designed
for the use case of running a Shiny app with the desired number of
daemons.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, <span class="fu">shiny</span><span class="fu">::</span><span class="fu">runApp</span><span class="op">(</span><span class="va">app</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note: in the above case, it is assumed the app is already created.
Wrapping a call to <code>shiny::shinyApp()</code> would not work as
<code>runApp()</code> is implicitly called when the app is printed,
however printing occurs only after <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> has returned,
hence the app would run outside of the scope of the <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code>
statement.</p>
<p>In the case of a Shiny app, all mirai calls will be executed before
the app returns. In the case of other expressions, be sure to call the
results (or collect the values) of all mirai within the expression so
that daemons are not reset before they have all completed.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="distributed-computing-remote-daemons">Distributed Computing: Remote Daemons<a class="anchor" aria-label="anchor" href="#distributed-computing-remote-daemons"></a>
</h3>
<p>The daemons interface may also be used to send tasks for computation
to remote daemon processes on the network.</p>
<p>Call <code><a href="../reference/daemons.html">daemons()</a></code> specifying ‘url’ as a character string
such as: ‘tcp://10.75.32.70:5555’ at which daemon processes should
connect. Alternatively, use <code><a href="../reference/host_url.html">host_url()</a></code> to automatically
construct a valid URL. The host / dispatcher listens at this address,
utilising a single port.</p>
<p>IPv6 addresses are also supported and must be enclosed in square
brackets <code>[]</code> to avoid confusion with the final colon
separating the port. For example, port 5555 on the IPv6 address
<code>::ffff:a6f:50d</code> would be specified as
<code>tcp://[::ffff:a6f:50d]:5555</code>.</p>
<p>For options on actually launching the daemons, please see the next
section.</p>
<p>Below, calling <code><a href="../reference/host_url.html">host_url()</a></code> without a port value uses the
default of ‘0’. This is a wildcard value that will automatically cause a
free ephemeral port to be assigned:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>The actual assigned port may be queried at any time via
<code><a href="../reference/status.html">status()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $connections</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $daemons</span></span>
<span><span class="co">#&gt; [1] "tcp://hostname:34177"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mirai</span></span>
<span><span class="co">#&gt;  awaiting executing completed </span></span>
<span><span class="co">#&gt;         0         0         0</span></span></code></pre></div>
<p>Dispatcher automatically adjusts to the number of daemons actually
connected. Hence it is possible to dynamically scale up or down the
number of daemons according to requirements.</p>
<p>To reset all connections and revert to default behaviour:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Closing the connection causes the dispatcher to exit automatically,
and in turn all connected daemons when their respective connections with
the dispatcher are terminated.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="distributed-computing-launching-daemons">Distributed Computing: Launching Daemons<a class="anchor" aria-label="anchor" href="#distributed-computing-launching-daemons"></a>
</h3>
<p>To launch remote daemons, supply a remote launch configuration to the
‘remote’ argument of <code><a href="../reference/daemons.html">daemons()</a></code> when setting up daemons, or
<code><a href="../reference/launch_local.html">launch_remote()</a></code> at any time afterwards.</p>
<p><code><a href="../reference/remote_config.html">ssh_config()</a></code> may be used to generate a remote launch
configuration if there is SSH access to the remote machine. Otherwise
<code><a href="../reference/remote_config.html">remote_config()</a></code> provides a flexible method for generating a
configuration involving a custom resource manager / application.</p>
<div class="section level4">
<h4 id="ssh-direct-connection">SSH Direct Connection<a class="anchor" aria-label="anchor" href="#ssh-direct-connection"></a>
</h4>
<p>This method is appropriate for internal networks and in trusted,
properly-configured environments where it is safe for your machine to
accept incoming connections on certain ports. In the examples below, the
remote daemons connect back directly to port 5555 on the local
machine.</p>
<p>In these cases, using TLS is often desirable to provide additional
security to the connections.</p>
<p>The first example below launches 4 daemons on the machine 10.75.32.90
(using the default SSH port of 22 as this was not specified), connecting
back to the host URL:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span>tls <span class="op">=</span> <span class="cn">TRUE</span>, port <span class="op">=</span> <span class="fl">5555</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">ssh_config</a></span><span class="op">(</span><span class="st">"ssh://10.75.32.90"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The second example below launches one daemon on each of 10.75.32.90
and 10.75.32.91 using the custom SSH port of 222:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span>tls <span class="op">=</span> <span class="cn">TRUE</span>, port <span class="op">=</span> <span class="fl">5555</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">ssh_config</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ssh://10.75.32.90:222"</span>, <span class="st">"ssh://10.75.32.91:222"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="ssh-tunnelling">SSH Tunnelling<a class="anchor" aria-label="anchor" href="#ssh-tunnelling"></a>
</h4>
<p>Use SSH tunnelling to launch daemons on any machine you are able to
access via SSH, whether on the local network or the cloud. SSH key-based
authentication must already be in place, but no other configuration is
required.</p>
<p>This provides a convenient way to launch remote daemons without them
needing to directly access the host. Firewall configurations or security
policies often prevent opening a port to accept outside connections. In
these cases, SSH tunnelling creates a tunnel once the initial SSH
connection is made. For simplicity, the implementation in mirai uses the
same tunnel port on both the host and daemon.</p>
<p>To use tunnelling, supply a URL with hostname of ‘127.0.0.1’ to ‘url’
for the <code><a href="../reference/daemons.html">daemons()</a></code> call.</p>
<ul>
<li>
<code>local_url(tcp = TRUE)</code> does this for you.</li>
<li>The default uses the wildcard port of ‘0’, which assigns a free
ephemeral port.</li>
<li>Whilst convenient, there is a small possibility that this port may
not be available on all daemons.</li>
<li>It is hence preferable to specify a specific port that has been
whitelisted for use, where possible.</li>
</ul>
<p>For example, if <code>local_url(tcp = TRUE, port = 5555)</code> is
specified, the tunnel is created using port 5555 on each machine. The
host listens to <code>127.0.0.1:5555</code> on its side, and the daemons
each dial into <code>127.0.0.1:5555</code> on their own respective
machines.</p>
<p>The below example launches 2 daemons on the remote machine
10.75.32.90 using SSH tunnelling:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">local_url</a></span><span class="op">(</span>tcp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">ssh_config</a></span><span class="op">(</span><span class="st">"ssh://10.75.32.90"</span>, tunnel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="cluster-resource-managers">Cluster Resource Managers<a class="anchor" aria-label="anchor" href="#cluster-resource-managers"></a>
</h4>
<p><code><a href="../reference/remote_config.html">remote_config()</a></code> may be used to run a command to deploy
daemons using a resource manager.</p>
<p>Taking Slurm as an example, the following uses <code>sbatch</code> to
launch a daemon on the cluster, with some additional arguments to
<code>sbatch</code> specifying the resource allocation:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">remote_config</a></span><span class="op">(</span></span>
<span>    command <span class="op">=</span> <span class="st">"sbatch"</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"--mem 512"</span>, <span class="st">"-n 1"</span>, <span class="st">"--wrap"</span>, <span class="st">"."</span><span class="op">)</span>,</span>
<span>    rscript <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home</a></span><span class="op">(</span><span class="st">"bin"</span><span class="op">)</span>, <span class="st">"Rscript"</span><span class="op">)</span>,</span>
<span>    quote <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="manual-deployment">Manual Deployment<a class="anchor" aria-label="anchor" href="#manual-deployment"></a>
</h4>
<p>As an alternative to automated launches, calling
<code><a href="../reference/launch_local.html">launch_remote()</a></code> without specifying ‘remote’ may be used to
return the shell commands for deploying daemons manually. The printed
return values may be copy / pasted directly to a remote machine.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="../reference/launch_local.html">launch_remote</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]</span></span>
<span><span class="co">#&gt; Rscript -e 'mirai::daemon("tcp://hostname:43597",dispatcher=TRUE,rs=c(10407,-437264371,797184874,-718672413,-1047853624,291948841,-256955690))'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [2]</span></span>
<span><span class="co">#&gt; Rscript -e 'mirai::daemon("tcp://hostname:43597",dispatcher=TRUE,rs=c(10407,-907483980,-843706119,734367554,1481479619,-1897686049,151158264))'</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="distributed-computing-tls-secure-connections">Distributed Computing: TLS Secure Connections<a class="anchor" aria-label="anchor" href="#distributed-computing-tls-secure-connections"></a>
</h3>
<p>TLS is available as an option to secure communications from the local
machine to remote daemons.</p>
<div class="section level4">
<h4 id="zero-configuration">Zero-configuration<a class="anchor" aria-label="anchor" href="#zero-configuration"></a>
</h4>
<p>An automatic zero-configuration default is implemented. Simply
specify a secure URL using the scheme <code>tls+tcp://</code> when
setting daemons, or use <code>host_url(tls = TRUE)</code>, for
example:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span>tls <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Single-use keys and certificates are automatically generated and
configured, without requiring any further intervention. The private key
is always retained on the host machine and never transmitted.</p>
<p>The generated self-signed certificate is available via
<code><a href="../reference/launch_local.html">launch_remote()</a></code>. This function conveniently constructs the
full shell command to launch a daemon, including the correctly specified
‘tls’ argument to <code><a href="../reference/daemon.html">daemon()</a></code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/launch_local.html">launch_remote</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]</span></span>
<span><span class="co">#&gt; Rscript -e 'mirai::daemon("tls+tcp://hostname:33887",dispatcher=TRUE,tls=c("-----BEGIN CERTIFICATE-----</span></span>
<span><span class="co">#&gt; MIIFNzCCAx+gAwIBAgIBATANBgkqhkiG9w0BAQsFADAzMREwDwYDVQQDDAhrdW1h</span></span>
<span><span class="co">#&gt; bW90bzERMA8GA1UECgwITmFub25leHQxCzAJBgNVBAYTAkpQMB4XDTAxMDEwMTAw</span></span>
<span><span class="co">#&gt; MDAwMFoXDTMwMTIzMTIzNTk1OVowMzERMA8GA1UEAwwIa3VtYW1vdG8xETAPBgNV</span></span>
<span><span class="co">#&gt; BAoMCE5hbm9uZXh0MQswCQYDVQQGEwJKUDCCAiIwDQYJKoZIhvcNAQEBBQADggIP</span></span>
<span><span class="co">#&gt; ADCCAgoCggIBAMT6jqapyBgL7OzxXiQaTZWZp24S9EW9ci6m+oT6oOJ25CdXE1WJ</span></span>
<span><span class="co">#&gt; GbAUqmyPyX4KaOUeMuaE6n7a1ov333L5VK+1s+uUOiAnk5dtAWxWvQqUuR6QnTbV</span></span>
<span><span class="co">#&gt; TYV/3spHe70aa+8eg+aiscfj+Zc09iAKhPsNrJOlPACWhdXDUFgM3soHqUBKoPlL</span></span>
<span><span class="co">#&gt; T44PI06ykdyb9hOxnAdT83BMt1LhY7tGaC9t+Yqe6ZmJV2BTIuV2jmqVcHE0dI+/</span></span>
<span><span class="co">#&gt; 9ZRExUkifMyZsGY/6aHZ8BGIJuELowDcNYJRENE6WqHPFfFmCc4o3vFpFZR7+80G</span></span>
<span><span class="co">#&gt; eUQR7BwBVaLLPNDT9ey4wEcDybQHtPl39IFja60D3ya0Qii6r5g5Rd83JX0abr0o</span></span>
<span><span class="co">#&gt; EFLy0U6ukKIi139q+jx0jfbE2cjlelfGNQtsdPATeFAyp4I1M9fAJDm7HxohR0Ps</span></span>
<span><span class="co">#&gt; hiq6kL+RrIKlAiyHKzPLAQduXjNmltl/Q0Pu/+QZoyHsZ++34+Kzayy/LSPFy2mX</span></span>
<span><span class="co">#&gt; hyXjOtCgp+kQK/gI3hC5FswxkILykF6x/+5+CJNIvwqFyWtQpcjxd6onxCLM5wNs</span></span>
<span><span class="co">#&gt; LWecLoeIJBolR9gID1c31Ijwln41XI5SfFMZgRwCMoRy4zBNJTtr47HcjqAwG6wV</span></span>
<span><span class="co">#&gt; tne3hUJglJCLMdrkb2zCVzrrqDyBxzX2qkhwQHdHIdggRItdDMJnYrizAgMBAAGj</span></span>
<span><span class="co">#&gt; VjBUMBIGA1UdEwEB/wQIMAYBAf8CAQAwHQYDVR0OBBYEFN2SqiKH9mYOjxR9qZMW</span></span>
<span><span class="co">#&gt; CTIuYYcjMB8GA1UdIwQYMBaAFN2SqiKH9mYOjxR9qZMWCTIuYYcjMA0GCSqGSIb3</span></span>
<span><span class="co">#&gt; DQEBCwUAA4ICAQCtLaE6pqP/ZTgPjrzv2VTIDrE+Ek3Ahm/R06QmCaZJh/wdwQcn</span></span>
<span><span class="co">#&gt; LE83vfv6oKusGKyMS4VwYT340KwCjgbYAGbncJy5e1BawgRS11vSqp4K0iHGWB+c</span></span>
<span><span class="co">#&gt; tqKLWsvmg/mLUL7zJ6yQUCA+a2PnEwB9pH8sO3aiKxvnE+/XimPD+/bGTwUEE/Bc</span></span>
<span><span class="co">#&gt; ZScC70e4CnCDrkjGKq7mGU7RCqUXIZ9rtRYOjLQhxUNfykxDIiLdYbRYCHhIsoEd</span></span>
<span><span class="co">#&gt; JGZBLv4QjRNR7GXhyJXqYQnjeW9qUE8idmZStMl7uRHpv0RzZfg90NaOH6F2aChS</span></span>
<span><span class="co">#&gt; ICwzJdNOxoi2jgFZKDRuj40q8x5YB8bDl1llwQfSydmvVW47jVHTDrJ/8et3ZPPD</span></span>
<span><span class="co">#&gt; A1zVPAeZZ2k5BdSn/J/7HdqW6mAPfTTdpA7qYzgohtLufDvAxIg8xuTVL3INdkdY</span></span>
<span><span class="co">#&gt; MFiQ67ow+mzgwcI5Fyfz457q3K8YPy4hDR+2AH8og5UN9XKdcFdYrC1LLDw0t65Y</span></span>
<span><span class="co">#&gt; LVdaGdhZrIqL+oesK9pcYA4YKuZbaBVvb4W6BHIlp0DrqAgAgNrHTA44g4j+hYqu</span></span>
<span><span class="co">#&gt; sl6gLKOg0ZLrJSMswyiNgYCzzGePw2AmR+/m0oswoUq4QpFswSCP0u6HpcZaqWFb</span></span>
<span><span class="co">#&gt; PgYjD1pB0qpQExYCMVJxMdcThzwFE1w6KrV64zH51w62fgnKSkxf85HNdA==</span></span>
<span><span class="co">#&gt; -----END CERTIFICATE-----</span></span>
<span><span class="co">#&gt; ",""),rs=c(10407,1452593982,-1222291801,-595233092,-727474035,918272490,380551779))'</span></span></code></pre></div>
<p>The printed value may be deployed directly on a remote machine.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level4">
<h4 id="ca-signed-certificates">CA Signed Certificates<a class="anchor" aria-label="anchor" href="#ca-signed-certificates"></a>
</h4>
<p>As an alternative to the zero-configuration default, a certificate
may also be generated via a Certificate Signing Request (CSR) to a
Certificate Authority (CA). The CA may be a public CA or internal to an
organisation.</p>
<ol style="list-style-type: decimal">
<li>Generate a private key and CSR. The following resources describe how
to do so:</li>
</ol>
<ul>
<li>using Mbed TLS: <a href="https://mbed-tls.readthedocs.io/en/latest/kb/how-to/generate-a-certificate-request-csr/" class="external-link uri">https://mbed-tls.readthedocs.io/en/latest/kb/how-to/generate-a-certificate-request-csr/</a>
</li>
<li>using OpenSSL: <a href="https://www.feistyduck.com/library/openssl-cookbook/online/" class="external-link uri">https://www.feistyduck.com/library/openssl-cookbook/online/</a>
(Chapter 1.2 Key and Certificate Management)</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Provide the generated CSR to the CA for it to sign a new TLS
certificate.</li>
</ol>
<ul>
<li>The common name (CN) of the certificate must be identical to the
hostname or IP address actually used for the connection. As this is
verified, it will fail if not the same.</li>
<li>The received certificate should comprise a block of cipher text
between the markers <code>-----BEGIN CERTIFICATE-----</code> and
<code>-----END CERTIFICATE-----</code>. Make sure to request the
certificate in the PEM format. If only available in other formats, the
TLS library used should usually provide conversion utilities.</li>
<li>Check also that the private key is a block of cipher text between
the markers <code>-----BEGIN PRIVATE KEY-----</code> and
<code>-----END PRIVATE KEY-----</code>.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>When setting daemons, the TLS certificate and private key should be
provided to the ‘tls’ argument of <code><a href="../reference/daemons.html">daemons()</a></code>.</li>
</ol>
<ul>
<li>If the certificate and private key have been imported as character
strings <code>cert</code> and <code>key</code> respectively, then the
‘tls’ argument may be specified as the character vector
<code>c(cert, key)</code>.</li>
<li>Alternatively, the certificate may be copied to a new text file,
with the private key appended, in which case the path/filename of this
file may be provided to the ‘tls’ argument.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>When launching daemons, the certificate chain to the CA should be
supplied to the ‘tls’ argument of <code><a href="../reference/daemon.html">daemon()</a></code> or
<code><a href="../reference/launch_local.html">launch_remote()</a></code>.</li>
</ol>
<ul>
<li>The certificate chain should comprise multiple certificates, each
between <code>-----BEGIN CERTIFICATE-----</code> and
<code>-----END CERTIFICATE-----</code> markers. The first one should be
the newly-generated TLS certificate, the same supplied to
<code><a href="../reference/daemons.html">daemons()</a></code>, and the final one should be a CA root
certificate.</li>
<li>These are the only certificates required if the certificate was
signed directly by a CA. If not, then the intermediate certificates
should be included in a certificate chain that starts with the TLS
certificate and ends with the certificate of the CA.</li>
<li>If these are concatenated together as a single character string
<code>certchain</code>, then the character vector comprising this and an
empty character string <code>c(certchain, "")</code> may be supplied to
the relevant ‘tls’ argument.</li>
<li>Alternatively, if these are written to a file (and the file
replicated on the remote machines), then the ‘tls’ argument may also be
specified as a path/filename (assuming these are the same on each
machine).</li>
</ul>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="compute-profiles">Compute Profiles<a class="anchor" aria-label="anchor" href="#compute-profiles"></a>
</h3>
<p>The <code><a href="../reference/daemons.html">daemons()</a></code> interface also allows the specification of
compute profiles for managing tasks with heterogeneous compute
requirements:</p>
<ul>
<li>send tasks to different daemons or clusters of daemons with the
appropriate specifications (in terms of CPUs / memory / GPU /
accelerators etc.)</li>
<li>split tasks between local and remote computation</li>
</ul>
<p>Simply specify the argument <code>.compute</code> when calling
<code><a href="../reference/daemons.html">daemons()</a></code> with a profile name (which is ‘default’ for the
default profile). The daemons settings are saved under the named
profile.</p>
<p>To create a ‘mirai’ task using a specific compute profile, specify
the ‘.compute’ argument to <code><a href="../reference/mirai.html">mirai()</a></code>, which defaults to the
‘default’ compute profile.</p>
<p>Similarly, functions such as <code><a href="../reference/status.html">status()</a></code>,
<code><a href="../reference/launch_local.html">launch_local()</a></code> or <code><a href="../reference/launch_local.html">launch_remote()</a></code> should be
specified with the desired ‘.compute’ argument.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="errors-interrupts-and-timeouts">Errors, Interrupts and Timeouts<a class="anchor" aria-label="anchor" href="#errors-interrupts-and-timeouts"></a>
</h3>
<p>If execution in a mirai fails, the error message is returned as a
character string of class ‘miraiError’ and ‘errorValue’ to facilitate
debugging. <code><a href="../reference/is_mirai_error.html">is_mirai_error()</a></code> may be used to test for mirai
execution errors.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"occurred with a custom message"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m1</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error: occurred with a custom message</span></span>
<span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m2</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error in mirai::mirai(): missing expression, perhaps wrap in {}?</span></span>
<span></span>
<span><span class="fu"><a href="../reference/is_mirai_error.html">is_mirai_error</a></span><span class="op">(</span><span class="va">m2</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="../reference/is_mirai_error.html">is_error_value</a></span><span class="op">(</span><span class="va">m2</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>A full stack trace of evaluation within the mirai is recorded and
accessible at <code>$stack.trace</code> on the error object.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"positive"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="op">{</span><span class="fu">f</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>; <span class="fu">f</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">}</span>, f <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">m3</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error in f(1): positive</span></span>
<span></span>
<span><span class="va">m3</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">stack.trace</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; stop("positive")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; f(1)</span></span></code></pre></div>
<p>Elements of the original error condition are also accessible via
<code>$</code> on the error object. For example, additional metadata
recorded by <code><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">rlang::abort()</a></code> is preserved:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"positive"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"aborted"</span>, meta_uid <span class="op">=</span> <span class="st">"UID001"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m4</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error: aborted</span></span>
<span></span>
<span><span class="va">m4</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">meta_uid</span></span>
<span><span class="co">#&gt; [1] "UID001"</span></span></code></pre></div>
<p>If a daemon instance is sent a user interrupt, the mirai will resolve
to an object of class ‘miraiInterrupt’ and ‘errorValue’.
<code><a href="../reference/is_mirai_error.html">is_mirai_interrupt()</a></code> may be used to test for such
interrupts.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/interrupt.html" class="external-link">interrupt</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># simulates a user interrupt</span></span>
<span><span class="fu"><a href="../reference/is_mirai_error.html">is_mirai_interrupt</a></span><span class="op">(</span><span class="va">m4</span><span class="op">[</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>If execution of a mirai surpasses the timeout set via the ‘.timeout’
argument, the mirai will resolve to an ‘errorValue’ of 5L (timed out).
This can, amongst other things, guard against mirai processes that have
the potential to hang and never return.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">nanonext</span><span class="fu">::</span><span class="fu"><a href="https://shikokuchuo.net/nanonext/reference/msleep.html" class="external-link">msleep</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, .timeout <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">m5</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'errorValue' int 5 | Timed out</span></span>
<span></span>
<span><span class="fu"><a href="../reference/is_mirai_error.html">is_mirai_error</a></span><span class="op">(</span><span class="va">m5</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/is_mirai_error.html">is_mirai_interrupt</a></span><span class="op">(</span><span class="va">m5</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu"><a href="../reference/is_mirai_error.html">is_error_value</a></span><span class="op">(</span><span class="va">m5</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p><code><a href="../reference/is_mirai_error.html">is_error_value()</a></code> tests for all mirai execution errors,
user interrupts and timeouts.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="serialization-arrow-polars-and-beyond">Serialization: Arrow, polars and beyond<a class="anchor" aria-label="anchor" href="#serialization-arrow-polars-and-beyond"></a>
</h3>
<p>Native R serialization is used for sending data between host and
daemons. Some R objects by their nature cannot be serialized, such as
those accessed via an external pointer. In these cases, performing
‘mirai’ operations on them would normally error.</p>
<p>Using the <a href="https://arrow.apache.org/docs/r/" class="external-link"><code>arrow</code></a> package
as an example:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">as_arrow_table</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error: Invalid &lt;Table&gt;, external pointer to null</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>However, <code><a href="../reference/serial_config.html">serial_config()</a></code> can be used to create custom
serialization configurations, specifying functions that hook into R’s
native serialization mechanism for reference objects (‘refhooks’).</p>
<p>This configuration may then be passed to the ‘serial’ argument of a
<code><a href="../reference/daemons.html">daemons()</a></code> call.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"ArrowTabular"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 6 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;dictionary&lt;values=string, indices=int8&gt;&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See $metadata for additional Schema metadata</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "some text"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>It can be seen that this time, the arrow table is seamlessly handled
in the ‘mirai’ process. This is the case even when the object is deeply
nested inside lists or other structures.</p>
<p>Different serialization functions may be registered for different
compute profiles. As an example, the ‘polars’ profile can be set up to
use <a href="https://pola-rs.github.io/r-polars/" class="external-link"><code>polars</code></a>, a
‘lightning fast’ dataframe library written in Rust (requires
<code>polars</code> &gt;= 0.16.4).</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  serial <span class="op">=</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>    class <span class="op">=</span> <span class="st">"RPolarsDataFrame"</span>,</span>
<span>    sfunc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">polars</span><span class="fu">::</span><span class="fu">as_polars_df</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="fu">to_raw_ipc</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    ufunc <span class="op">=</span> <span class="fu">polars</span><span class="fu">::</span><span class="va">pl</span><span class="op">$</span><span class="va">read_ipc</span></span>
<span>  <span class="op">)</span>,</span>
<span>  .compute <span class="op">=</span> <span class="st">"polars"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">polars</span><span class="fu">::</span><span class="fu">as_polars_df</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span>, .compute <span class="op">=</span> <span class="st">"polars"</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; shape: (6, 5)</span></span>
<span><span class="co">#&gt; ┌──────────────┬─────────────┬──────────────┬─────────────┬─────────┐</span></span>
<span><span class="co">#&gt; │ Sepal.Length ┆ Sepal.Width ┆ Petal.Length ┆ Petal.Width ┆ Species │</span></span>
<span><span class="co">#&gt; │ ---          ┆ ---         ┆ ---          ┆ ---         ┆ ---     │</span></span>
<span><span class="co">#&gt; │ f64          ┆ f64         ┆ f64          ┆ f64         ┆ cat     │</span></span>
<span><span class="co">#&gt; ╞══════════════╪═════════════╪══════════════╪═════════════╪═════════╡</span></span>
<span><span class="co">#&gt; │ 5.1          ┆ 3.5         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.9          ┆ 3.0         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.7          ┆ 3.2         ┆ 1.3          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.6          ┆ 3.1         ┆ 1.5          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 5.0          ┆ 3.6         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 5.4          ┆ 3.9         ┆ 1.7          ┆ 0.4         ┆ setosa  │</span></span>
<span><span class="co">#&gt; └──────────────┴─────────────┴──────────────┴─────────────┴─────────┘</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "some text"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span>, .compute <span class="op">=</span> <span class="st">"polars"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>The ‘vec’ argument to <code>serialization()</code> may be specified
as <code>TRUE</code> if the serialization functions are vectorized and
take lists of objects, as is the case for <a href="https://mlverse.github.io/safetensors/" class="external-link"><code>safetensors</code></a>,
used for serialization in <a href="https://torch.mlverse.org/" class="external-link"><code>torch</code></a>.</p>
<p>Please refer to the <a href="https://shikokuchuo.net/mirai/articles/torch.html">torch
vignette</a> for further examples.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="asynchronous-parallel-map">Asynchronous Parallel Map<a class="anchor" aria-label="anchor" href="#asynchronous-parallel-map"></a>
</h3>
<p><code><a href="../reference/mirai_map.html">mirai_map()</a></code> performs asynchronous parallel/distributed
map using <code>mirai</code>.</p>
<p>This function is similar to <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code>, but returns a
‘mirai_map’ object. It is also more advanced as it allows multiple map
over the rows of a dataframe or matrix - and can in fact be used to
implement all map variations from that package.</p>
<p>The results of a mirai_map <code>x</code> may be collected using
<code>x[]</code>. This waits for all asynchronous operations to complete
if still in progress.</p>
<div class="section level4">
<h4 id="key-advantages">Key advantages:<a class="anchor" aria-label="anchor" href="#key-advantages"></a>
</h4>
<ol style="list-style-type: decimal">
<li>Returns immediately with all evaluations taking place
asynchronously. Printing a ‘mirai map’ object shows the current
completion progress.</li>
<li>The ‘.promise’ argument allows a promise to registered against each
mirai, which can be used to perform side-effects.</li>
<li>Returns evaluation errors as ‘miraiError’ or ‘errorValue’ as the
case may be, rather than causing the entire operation to fail. This
allows more efficient recovery from partial failure.</li>
<li>Does not rely on a ‘chunking’ algorithm that attempts to split work
into batches according to the number of available daemons, as
implemented for example in the <code>parallel</code> package. Chunking
cannot take into account varying or unpredictable compute times over the
indices. It can be optimal to rely on <code>mirai</code> for scheduling
instead. This is demonstrated in the example below.</li>
</ol>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shikokuchuo.net/mirai/">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_cluster.html">make_cluster</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="va">vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="va">vec</span>, <span class="va">Sys.sleep</span><span class="op">)</span><span class="op">[</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.010   0.100   4.008</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">vec</span>, <span class="va">Sys.sleep</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.010   0.006   8.012</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><code>.args</code> is used to specify further constant arguments to
<code>.f</code> - the ‘mean’ and ‘sd’ in the example below:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">3</span>, dispatcher <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">rnorm</span>, .args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">20</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 21.17536</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 18.76426 19.14900</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 20.58926 19.62160 18.28402</span></span></code></pre></div>
<p>Use <code>...</code> to further specify objects referenced but not
defined in <code>.f</code> - the ‘do’ in the anonymous function
below:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="va">ml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">2</span>, c <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">do</span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  do <span class="op">=</span> <span class="fu">nanonext</span><span class="fu">::</span><span class="va"><a href="https://shikokuchuo.net/nanonext/reference/random.html" class="external-link">random</a></span></span>
<span><span class="op">)</span></span>
<span><span class="va">ml</span></span>
<span><span class="co">#&gt; &lt; mirai map [0/3] &gt;</span></span>
<span><span class="va">ml</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] "4f"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 9a 61</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $c</span></span>
<span><span class="co">#&gt; [1] "f03aec"</span></span></code></pre></div>
<p>Use of <code><a href="../reference/mirai_map.html">mirai_map()</a></code> requires that <code><a href="../reference/daemons.html">daemons()</a></code>
have previously been set, and will error if not.</p>
</div>
<div class="section level4">
<h4 id="collecting-results">Collecting Results<a class="anchor" aria-label="anchor" href="#collecting-results"></a>
</h4>
<p>When collecting the results, optionally specify arguments to
<code>[]</code>:</p>
<ul>
<li>
<code>x[.flat]</code> collects and flattens the results, checking
that they are of the same type to avoid coercion.</li>
<li>
<code>x[.progress]</code> collects results using a <code>cli</code>
progress bar, if available, showing completion percentage and ETA, or
else a simple text progress indicator of parts completed of the total.
If the map operation completes quickly, the <code>cli</code> progress
bar may not show at all, and this is by design.</li>
<li>
<code>x[.stop]</code> collects the results applying early stopping,
which stops at the first failure and cancels remaining computations. If
the <code>cli</code> package is available, it will be used for
displaying the error message.</li>
</ul>
<p>Combinations of the above may be supplied in the fashion of
<code>x[.stop, .progress]</code>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="st">"a"</span>, c <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">.stop</span><span class="op">]</span></span>
<span><span class="co">#&gt; Error in `mirai_map()`:</span></span>
<span><span class="co">#&gt; ℹ In index: 2.</span></span>
<span><span class="co">#&gt; ℹ With name: b.</span></span>
<span><span class="co">#&gt; Caused by error in `exp()`:</span></span>
<span><span class="co">#&gt; ! non-numeric argument to mathematical function</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">4</span>, dispatcher <span class="op">=</span> <span class="cn">FALSE</span>, .compute <span class="op">=</span> <span class="st">"sleep"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span><span class="op">)</span>, <span class="va">Sys.sleep</span>, .compute <span class="op">=</span> <span class="st">"sleep"</span><span class="op">)</span><span class="op">[</span><span class="va">.progress</span>, <span class="va">.flat</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="multiple-map">Multiple Map<a class="anchor" aria-label="anchor" href="#multiple-map"></a>
</h4>
<p>Multiple map is performed over the <strong>rows</strong> of a
dataframe or matrix, as this is most often the desired behaviour.</p>
<p>This allows map over 2 or more arguments by specifying a dataframe.
One of those may be an index value for indexed map.</p>
<p>The function <code>.f</code> must take as many arguments as there are
columns, either explicitly or via <code>...</code>.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fruit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"melon"</span>, <span class="st">"grapes"</span>, <span class="st">"coconut"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a dataframe for indexed map:</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">fruit</span><span class="op">)</span>, fruit <span class="op">=</span> <span class="va">fruit</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">3</span>, dispatcher <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/mirai_map.html">mirai_map</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">sprintf</span>, .args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fmt <span class="op">=</span> <span class="st">"%d. %s"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">.flat</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1. melon"   "2. grapes"  "3. coconut"</span></span></code></pre></div>
<p>As a dataframe often contains columns of differing type, it is
unusual to want to map over the <strong>columns</strong>, however this
is possible by simply transforming it beforehand into a list using
<code><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list()</a></code>.</p>
<p>Similarly, the behaviour of <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code> or
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code> on a matrix is the same as that for a vector.
<code><a href="../reference/mirai_map.html">mirai_map()</a></code> on the other hand does take into account the
fact that the matrix has dimensions, and maps over its
<strong>rows</strong>, consistent with the behaviour for dataframes. If
instead, mapping over the columns is desired, simply take the transpose
of the matrix beforehand using <code><a href="https://rdrr.io/r/base/t.html" class="external-link">t()</a></code>.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="using-mirai-in-a-package">Using mirai in a Package<a class="anchor" aria-label="anchor" href="#using-mirai-in-a-package"></a>
</h3>
<p>mirai as a framework is designed to support completely transparent
and inter-operable use within packages. A core design precept of not
relying on global options or environment variables minimises the
likelihood of conflict between use by different packages.</p>
<p>There are hence few requirements of package authors, but a few
important points to note nevertheless:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/daemons.html">daemons()</a></code> settings should almost always be left to
end-users. Consider re-exporting <code><a href="../reference/daemons.html">daemons()</a></code> in your package
as a convenience.</li>
</ol>
<ul>
<li>Do not include a call to <code><a href="../reference/daemons.html">daemons()</a></code> if you use
<code><a href="../reference/mirai_map.html">mirai_map()</a></code> or a function that wraps it such as
<code>purrr::map(.paralellel = TRUE)</code>. This is important to ensure
that there is no unintentional recursive creation of daemons on the same
machine.</li>
<li>Where a <code><a href="../reference/daemons.html">daemons()</a></code> call may be appropriate is for async
operation using only one dedicated daemon. A representative examaple of
this usage pattern is <code>logger::appender_async()</code>, where the
logger package’s ‘namespace’ concept maps directly to mirai’s ‘compute
profile’.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>The shape and contents of a <code><a href="../reference/status.html">status()</a></code> call must not be
relied upon, as this user interface is subject to change at any
time.</li>
</ol>
<ul>
<li>There is a developer interface <code><a href="../reference/nextstream.html">nextget()</a></code>, for querying
values such as ‘urls’ described in the function documentation. Note:
only the specifically-documented values are supported interfaces.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>The functions <code><a href="../reference/unresolved.html">unresolved()</a></code>,
<code><a href="../reference/is_mirai_error.html">is_error_value()</a></code>, <code><a href="../reference/is_mirai_error.html">is_mirai_error()</a></code>, and
<code><a href="../reference/is_mirai_error.html">is_mirai_interrupt()</a></code> should be used to test for the
relevant state of a mirai or its value.</li>
</ol>
<ul>
<li>The characteristics of how they are currently implemented, e.g. as a
logical NA for an ‘unresolvedValue’, should not be relied upon, as these
are subject to change at any time.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Testing on CRAN should respect it’s 2-core usage limit. These limits
apply only to tests on CRAN, and more complex tests may be run
elsewhere.</li>
</ol>
<ul>
<li>This practically means limiting tests to using one daemon (with
<code>dispatcher = FALSE</code>) to ensure that only one additional
process is used.</li>
<li>Always reset daemons when done and then allow at least a one-second
sleep to ensure all background processes have properly exited.</li>
</ul>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Charlie Gao.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
