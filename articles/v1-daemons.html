<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1. Daemons • mirai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1. Daemons">
<script defer data-domain="mirai.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mirai</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mirai.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v1-daemons.html">1. Daemons</a></li>
    <li><a class="dropdown-item" href="../articles/v2-map.html">2. Async Parallel Map</a></li>
    <li><a class="dropdown-item" href="../articles/v3-promises.html">3. Promises - Shiny and Plumber</a></li>
    <li><a class="dropdown-item" href="../articles/v4-serialization.html">4. Serialization - Arrow, ADBC, polars, torch</a></li>
    <li><a class="dropdown-item" href="../articles/v5-parallel.html">5. Mirai Clusters - Base R</a></li>
    <li><a class="dropdown-item" href="../articles/v6-packages.html">6. Guidance for Package Authors</a></li>
    <li><a class="dropdown-item" href="../articles/v7-community.html">7. Community FAQs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/mirai/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>1. Daemons</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/mirai/blob/v2.3.0/vignettes/v1-daemons.Rmd" class="external-link"><code>vignettes/v1-daemons.Rmd</code></a></small>
      <div class="d-none name"><code>v1-daemons.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h3>
<ol style="list-style-type: decimal">
<li><a href="#local-daemons">Local Daemons</a></li>
<li><a href="#remote-daemons">Remote Daemons</a></li>
<li><a href="#launching-remote-daemons">Launching Remote
Daemons</a></li>
<li><a href="#tls-secure-connections">TLS Secure Connections</a></li>
<li><a href="#compute-profiles">Compute Profiles</a></li>
</ol>
</div>
<div class="section level3">
<h3 id="local-daemons">Local Daemons<a class="anchor" aria-label="anchor" href="#local-daemons"></a>
</h3>
<p>Daemons, or persistent background processes, may be set to receive
‘mirai’ requests.</p>
<p>This is typically going to be more efficient as new processes no
longer need to be created on an <em>ad hoc</em> basis.</p>
<blockquote>
<p>Daemons inherit the default system configuration and read in the
relevant ‘.Renviron’ and ‘.Rprofile’ etc. on startup. They also load the
default packages. To instead only load the <code>base</code> package
(which cuts out more than half of R’s startup time), the environment
variable <code>R_SCRIPT_DEFAULT_PACKAGES=NULL</code> may be set prior to
launching daemons.</p>
</blockquote>
<div class="section level4">
<h4 id="with-dispatcher-default">With Dispatcher (default)<a class="anchor" aria-label="anchor" href="#with-dispatcher-default"></a>
</h4>
<p>Call <code><a href="../reference/daemons.html">daemons()</a></code> specifying the number of daemons to
launch.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>The default <code>dispatcher = TRUE</code> creates a
<code><a href="../reference/dispatcher.html">dispatcher()</a></code> background process that connects to individual
daemon processes on the local machine. This ensures that tasks are
dispatched efficiently on a first-in first-out (FIFO) basis to daemons
for processing. Tasks are queued at dispatcher and sent to a daemon as
soon as it can accept the task for immediate execution.</p>
<p>Dispatcher uses synchronisation primitives from <a href="https://nanonext.r-lib.org" class="external-link"><code>nanonext</code></a>, waiting
upon tasks rather than polling for them at intervals. This event-driven
approach is efficient both in consuming no resources while waiting,
whilst also having no latency being fully synchronised with events.</p>
<p>To view the current status, <code><a href="../reference/status.html">status()</a></code> provides:</p>
<ol style="list-style-type: decimal">
<li>The number of active connections,</li>
<li>The URL daemons connect to, and</li>
<li>A task summary:</li>
</ol>
<ul>
<li>
<code>waiting</code> number of tasks queued for execution at
dispatcher</li>
<li>
<code>assigned</code> number of tasks sent to a daemon for
execution</li>
<li>
<code>complete</code> number of tasks for which the result has been
received (either completed or cancelled)</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $connections</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $daemons</span></span>
<span><span class="co">#&gt; [1] "ipc:///tmp/c2c44fbab84c2abdc1dcec50"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mirai</span></span>
<span><span class="co">#&gt;  awaiting executing completed </span></span>
<span><span class="co">#&gt;         0         0         0</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Set the number of daemons to zero to reset. This reverts to the
default of creating a new background process for each ‘mirai’
request.</p>
</div>
<div class="section level4">
<h4 id="without-dispatcher">Without Dispatcher<a class="anchor" aria-label="anchor" href="#without-dispatcher"></a>
</h4>
<p>Alternatively, specifying <code>dispatcher = FALSE</code>, the
background daemons connect directly to the host process.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">6</span>, dispatcher <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>This means that tasks are sent immediately in a round-robin fashion,
which ensures that they are evenly-distributed amongst daemons. This
does not however guarantee optimal scheduling, as the duration of tasks
cannot be known <em>a priori</em>. As an example, tasks could be queued
at a daemon behind a long-running task, whilst other daemons are idle
having already completed their tasks.</p>
<p>The advantage of this approach is that it is resource-light and does
not require an additional dispatcher process. It is suited to working
with similar-length tasks, or where concurrent tasks typically do not
exceed available daemons.</p>
<p>Requesting the status now shows 6 connections, along with the host
URL:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $connections</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $daemons</span></span>
<span><span class="co">#&gt; [1] "ipc:///tmp/092bfa33b8c79e58a666b322"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="everywhere">Everywhere<a class="anchor" aria-label="anchor" href="#everywhere"></a>
</h4>
<p><code><a href="../reference/everywhere.html">everywhere()</a></code> may be used to evaluate an expression on
all connected daemons and persist the resultant state, regardless of a
daemon’s ‘cleanup’ setting.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The above keeps the <a href="https://dbi.r-dbi.org/" class="external-link"><code>DBI</code></a> package loaded for
all evaluations. Other types of setup task may also be performed,
including making a common resource available, such as a database
connection:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="va">con</span> <span class="op">&lt;&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">SQLite</span><span class="op">(</span><span class="op">)</span>, <span class="va">file</span><span class="op">)</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>By super-assignment, the conenction ‘con’ will be available in the
global environment of all daemon instances. Subsequent mirai calls may
then make use of ‘con’.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"con"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Disconnect from the database everywhere:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Sometimes it may be necessary to evaluate an expression in the global
environment of each daemon. As mirai evaluation does not occur in the
global environment itself, but one inheriting from it, an explicit call
to <code>evalq(envir = .GlobalEnv)</code> achieves this. An example use
case is <code>box::use()</code> to import a module or package:</p>
</blockquote>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">evalq</a></span><span class="op">(</span></span>
<span>    <span class="fu">box</span><span class="fu">::</span><span class="fu">use</span><span class="op">(</span><span class="va">dplyr</span><span class="op">[</span><span class="va">select</span><span class="op">]</span>, <span class="va">mirai</span><span class="op">[</span><span class="va">...</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    envir <span class="op">=</span> <span class="va">.GlobalEnv</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="with-method">With Method<a class="anchor" aria-label="anchor" href="#with-method"></a>
</h4>
<p><code><a href="../reference/daemons.html">daemons()</a></code> has a <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> method, which
evaluates an expression with daemons created for the duration of the
expression and automatically torn down upon completion.</p>
<p>It was originally designed for running a Shiny app with the desired
number of daemons, as in the example below:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, <span class="fu">shiny</span><span class="fu">::</span><span class="fu">runApp</span><span class="op">(</span><span class="va">app</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Note: it is assumed the app is already created. Wrapping a call to
<code>shiny::shinyApp()</code> would not work as <code>runApp()</code>
is implicitly called when the app is printed, however printing occurs
only after <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> has returned, hence the app would run
outside of the scope of the <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> statement.</p>
</blockquote>
<p>In the case of a Shiny app, all mirai calls will be executed before
the app returns as the app itself is blocking. In the case of other
expressions, be sure to call the results (or collect the values) of all
mirai within the expression to ensure that they all complete before the
daemons are torn down.</p>
<p>If specifying a compute profile for the <code><a href="../reference/daemons.html">daemons()</a></code> call
(see below), all calls with <code>.compute = NULL</code> within the
<code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> clause will default to this compute profile.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="remote-daemons">Remote Daemons<a class="anchor" aria-label="anchor" href="#remote-daemons"></a>
</h3>
<p>The daemons interface may also be used to send tasks for computation
to remote daemon processes on the network.</p>
<p>Call <code><a href="../reference/daemons.html">daemons()</a></code> specifying ‘url’ as a character string
such as: ‘tcp://10.75.32.70:5555’ at which daemon processes should
connect. Alternatively, use <code><a href="../reference/host_url.html">host_url()</a></code> to automatically
construct a valid URL. The host (or dispatcher) listens at this address,
utilising a single port.</p>
<blockquote>
<p>IPv6 addresses are also supported and must be enclosed in square
brackets <code>[]</code> to avoid confusion with the final colon
separating the port. For example, port 5555 on the IPv6 address
<code>::ffff:a6f:50d</code> would be specified as
<code>tcp://[::ffff:a6f:50d]:5555</code>.</p>
</blockquote>
<p>For options on actually launching the daemons, please see the next
section.</p>
<p>Below, calling <code><a href="../reference/host_url.html">host_url()</a></code> without a port value uses the
default of ‘0’. This is a wildcard value that will automatically assigns
a free ephemeral port:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>The actual assigned port may be queried at any time via
<code><a href="../reference/status.html">status()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $connections</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $daemons</span></span>
<span><span class="co">#&gt; [1] "tcp://192.168.2.179:61815"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mirai</span></span>
<span><span class="co">#&gt;  awaiting executing completed </span></span>
<span><span class="co">#&gt;         0         0         0</span></span></code></pre></div>
<p>The number of daemons connected at any time may be dynamically scaled
up or down, according to requirements.</p>
<p>To reset all connections and revert to default behaviour:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Closing the connection causes all connected daemons to exit
automatically. If using dispatcher, it will cause dispatcher to exit,
and in turn all connected daemons when their respective connections with
the dispatcher are terminated.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level3">
<h3 id="launching-remote-daemons">Launching Remote Daemons<a class="anchor" aria-label="anchor" href="#launching-remote-daemons"></a>
</h3>
<p>To launch remote daemons, supply a remote launch configuration to the
‘remote’ argument of <code><a href="../reference/daemons.html">daemons()</a></code>, or
<code><a href="../reference/launch_local.html">launch_remote()</a></code> at any time thereafter.</p>
<p>There are currently two options for generating remote launch
configurations:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/remote_config.html">ssh_config()</a></code> if there is SSH access to the remote
machine.</li>
<li>
<code><a href="../reference/remote_config.html">remote_config()</a></code> provides a flexible method for using
cluster resource managers, or a custom launcher.</li>
</ol>
<div class="section level4">
<h4 id="ssh-direct-connection">SSH Direct Connection<a class="anchor" aria-label="anchor" href="#ssh-direct-connection"></a>
</h4>
<p>This method is appropriate for internal networks and in trusted,
properly-configured environments where it is safe for your machine to
accept incoming connections on certain ports. In the examples below, the
remote daemons connect back directly to port 5555 on the local
machine.</p>
<p>In these cases, using TLS is often desirable to provide additional
security to the connections.</p>
<p>The first example below launches 4 daemons on the machine 10.75.32.90
(using the default SSH port of 22 as this was not specified), connecting
back to the host URL:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span>tls <span class="op">=</span> <span class="cn">TRUE</span>, port <span class="op">=</span> <span class="fl">5555</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">ssh_config</a></span><span class="op">(</span><span class="st">"ssh://10.75.32.90"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The second example below launches one daemon on each of 10.75.32.90
and 10.75.32.91 using the custom SSH port of 222:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span>tls <span class="op">=</span> <span class="cn">TRUE</span>, port <span class="op">=</span> <span class="fl">5555</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">ssh_config</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ssh://10.75.32.90:222"</span>, <span class="st">"ssh://10.75.32.91:222"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="ssh-tunnelling">SSH Tunnelling<a class="anchor" aria-label="anchor" href="#ssh-tunnelling"></a>
</h4>
<p>Use SSH tunnelling to launch daemons on any machine you are able to
access via SSH, whether on the local network or the cloud. SSH key-based
authentication must already be in place, but no other configuration is
required.</p>
<p>This provides a convenient way to launch remote daemons without them
needing to directly access the host. Firewall configurations or security
policies often prevent opening a port to accept outside connections. In
these cases, SSH tunnelling creates a tunnel once the initial SSH
connection is made. For simplicity, the implementation in mirai uses the
same tunnel port on both the host and daemon.</p>
<p>To use tunnelling, supply a URL with hostname of ‘127.0.0.1’ to ‘url’
for the <code><a href="../reference/daemons.html">daemons()</a></code> call.</p>
<ul>
<li>
<code>local_url(tcp = TRUE)</code> does this for you.</li>
<li>The default uses the wildcard port of ‘0’, which assigns a free
ephemeral port.</li>
<li>Whilst convenient, there is a small possibility that this port may
not be available on all daemons.</li>
<li>It is hence preferable to specify a specific port that has been
whitelisted for use, where possible.</li>
</ul>
<p>For example, if <code>local_url(tcp = TRUE, port = 5555)</code> is
specified, the tunnel is created using port 5555 on each machine. The
host listens to <code>127.0.0.1:5555</code> on its side, and the daemons
each dial into <code>127.0.0.1:5555</code> on their own respective
machines.</p>
<p>The below example launches 2 daemons on the remote machine
10.75.32.90 using SSH tunnelling:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">local_url</a></span><span class="op">(</span>tcp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">ssh_config</a></span><span class="op">(</span><span class="st">"ssh://10.75.32.90"</span>, tunnel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="cluster-resource-managers">Cluster Resource Managers<a class="anchor" aria-label="anchor" href="#cluster-resource-managers"></a>
</h4>
<p><code><a href="../reference/remote_config.html">remote_config()</a></code> may be used to run a command to deploy
daemons using a resource manager.</p>
<p>Taking Slurm as an example, the following uses <code>sbatch</code> to
launch a daemon on the cluster, with some additional arguments to
<code>sbatch</code> specifying the resource allocation:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  remote <span class="op">=</span> <span class="fu"><a href="../reference/remote_config.html">remote_config</a></span><span class="op">(</span></span>
<span>    command <span class="op">=</span> <span class="st">"sbatch"</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"--mem 512"</span>, <span class="st">"-n 1"</span>, <span class="st">"--wrap"</span>, <span class="st">"."</span><span class="op">)</span>,</span>
<span>    rscript <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home</a></span><span class="op">(</span><span class="st">"bin"</span><span class="op">)</span>, <span class="st">"Rscript"</span><span class="op">)</span>,</span>
<span>    quote <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="manual-deployment">Manual Deployment<a class="anchor" aria-label="anchor" href="#manual-deployment"></a>
</h4>
<p>As an alternative to automated launches, calling
<code><a href="../reference/launch_local.html">launch_remote()</a></code> without specifying ‘remote’ may be used to
return the shell commands for deploying daemons manually.</p>
<p>The printed return values may then be copy / pasted directly to a
remote machine e.g. via a terminal session.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="../reference/launch_local.html">launch_remote</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]</span></span>
<span><span class="co">#&gt; Rscript -e 'mirai::daemon("tcp://192.168.2.179:61819",dispatcher=TRUE,rs=c(10407,91257334,-1959188481,-1949566412,1212153765,450893858,-19985093))'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [2]</span></span>
<span><span class="co">#&gt; Rscript -e 'mirai::daemon("tcp://192.168.2.179:61819",dispatcher=TRUE,rs=c(10407,-1946146075,-207229660,280621307,1679686356,-432010903,1372300061))'</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="tls-secure-connections">TLS Secure Connections<a class="anchor" aria-label="anchor" href="#tls-secure-connections"></a>
</h3>
<p>TLS provides a robust solution for securing communications from the
local machine to remote daemons.</p>
<div class="section level4">
<h4 id="automatic-zero-configuration-default">Automatic Zero-configuration Default<a class="anchor" aria-label="anchor" href="#automatic-zero-configuration-default"></a>
</h4>
<p>Simply specify a secure URL using the scheme <code>tls+tcp://</code>
when setting daemons, or use <code>host_url(tls = TRUE)</code>, for
example:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="../reference/host_url.html">host_url</a></span><span class="op">(</span>tls <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Single-use keys and certificates are automatically generated and
configured, without requiring any further intervention. The private key
is always retained on the host machine and never transmitted.</p>
<p>The generated self-signed certificate is available via
<code><a href="../reference/launch_local.html">launch_remote()</a></code>, where it is included as part of the shell
command for manually launching a daemon on a remote machine.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/launch_local.html">launch_remote</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]</span></span>
<span><span class="co">#&gt; Rscript -e 'mirai::daemon("tls+tcp://192.168.2.179:61823",dispatcher=TRUE,tls=c("-----BEGIN CERTIFICATE-----</span></span>
<span><span class="co">#&gt; MIIFQTCCAymgAwIBAgIBATANBgkqhkiG9w0BAQsFADA4MRYwFAYDVQQDDA0xOTIu</span></span>
<span><span class="co">#&gt; MTY4LjIuMTc5MREwDwYDVQQKDAhOYW5vbmV4dDELMAkGA1UEBhMCSlAwHhcNMDEw</span></span>
<span><span class="co">#&gt; MTAxMDAwMDAwWhcNMzAxMjMxMjM1OTU5WjA4MRYwFAYDVQQDDA0xOTIuMTY4LjIu</span></span>
<span><span class="co">#&gt; MTc5MREwDwYDVQQKDAhOYW5vbmV4dDELMAkGA1UEBhMCSlAwggIiMA0GCSqGSIb3</span></span>
<span><span class="co">#&gt; DQEBAQUAA4ICDwAwggIKAoICAQC1rQfohQMGO1G/nJfPXKwRIyTOh0+YN3rPb8Fq</span></span>
<span><span class="co">#&gt; 9YQisNJsZSAYWOCBZtcvfkhp6H3T8PkpHQpRvMqJRscvwBIGj5Q0wt9YlOiUL0nL</span></span>
<span><span class="co">#&gt; lKgrc06HpzTCMDkd+gDXFFzpIkC9kywycou5EJCbHPX35G1DWUnk5EFljq/Rphgt</span></span>
<span><span class="co">#&gt; oqF8orky7uxvV0okEN0/G4owdutIu7oj1bDDkyeAv2YwnQXhqd7qAtRlwBF25EMN</span></span>
<span><span class="co">#&gt; sHb7CEdW9L8W0W0delwdey0HjgNZulq5FE7Jhzh9w0fjSQU+bz+T2lxFZhdMa8AB</span></span>
<span><span class="co">#&gt; jwvOTFu+ruDd0H0N19u8yjc2hTjDLGSme4YoHsc0r8sFW2ebDSelPLiY4i+6RDud</span></span>
<span><span class="co">#&gt; m2DPve12LYd6L/qOPayE/IFOm3+L0DZeicy5e+qhmbnkQMy83wX4MXcxFME4e+oR</span></span>
<span><span class="co">#&gt; HiJjpR7VsmaCaDkWPQOA8K9+CMwhrCE1TJ8TNL6lQVf/jCwLFH11K24j2xFJd3xr</span></span>
<span><span class="co">#&gt; qqNaeSeTo7J+e9hgX+UCgT9Y01fzwaZIo9xmXtd7VwLlvh6MtJXhH6G47OiqqPVT</span></span>
<span><span class="co">#&gt; JDlQpqEilrxQgeOtvpzpVAafwUqeyTELwo6vovrOXZd++3v4ofPVYmZdLH+/fC1h</span></span>
<span><span class="co">#&gt; vyoflaga5LmkJqXvfNFUl/qW9VqsZJtD+ugMesWaFvISWLcmTw+fpxibaucX1mC+</span></span>
<span><span class="co">#&gt; QA/+aQIDAQABo1YwVDASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdDgQWBBTx8Dh/</span></span>
<span><span class="co">#&gt; y5xUx7oDd91v+d4RGDKiNDAfBgNVHSMEGDAWgBTx8Dh/y5xUx7oDd91v+d4RGDKi</span></span>
<span><span class="co">#&gt; NDANBgkqhkiG9w0BAQsFAAOCAgEAWd25sLJY/CCuHO4+AhT3PHJms9M9FkMrlfbA</span></span>
<span><span class="co">#&gt; ZXh/40UaNjFgFBYbJprPrQWZgH55Me29badP4OMcGpP+Jwfb1mE9CGq7iTIPEkoN</span></span>
<span><span class="co">#&gt; bQ12OQJIjj7CQZaEsukrnQPwj6aXZjHnDVA8GiMizEmEzEEj54qaEOCb+N1OsobI</span></span>
<span><span class="co">#&gt; vvFZGcHi2ktVMugGnCgIf1R5/2ojul+lArbPeItbOBf1EzEyIObVWG6NeFU9pcQ3</span></span>
<span><span class="co">#&gt; 18zSoBS3qhL44yxbmxponMf/Izw5AGtI6Ue1rLTab3lNp0eC8qt6buhs5Nef2gar</span></span>
<span><span class="co">#&gt; iTWjqhrChzdwc6a1rFkdpzA5xZqp6hE7Q3x0XSK5qZkixdOt6Y4yHcWkKXaKLOVN</span></span>
<span><span class="co">#&gt; o7M4UVw0b37oDXJc1lMoupUj8i+On34BpqU1A7EMNeSA64tSus15wUi8laIExpjc</span></span>
<span><span class="co">#&gt; UpfBLeSU5tayz43EXX1wZAXRLLOYGE4z4jmRcFzhwzLFKOZZJayD8uXWAN58wR0E</span></span>
<span><span class="co">#&gt; H4Y3RGWtINvz/H/k9lGYSYjXkQNnzpdBXxGD2TigCuINMpAzlhmlef72G3Cmv0+K</span></span>
<span><span class="co">#&gt; yxZwaM1h216NGGn4JXYbExwMJ2Ea1lFK57jLCidBeDJtKOu//0YBAZI+GUia8QdU</span></span>
<span><span class="co">#&gt; WqTluR6AP275Z7EG7oet2PYRrwvX30+OmFKDTrPFVupSTcnGAOlhAPAGtweFsrwo</span></span>
<span><span class="co">#&gt; zLI1mR8=</span></span>
<span><span class="co">#&gt; -----END CERTIFICATE-----</span></span>
<span><span class="co">#&gt; ",""),rs=c(10407,-1505249000,-2064814023,-250690906,-1957016337,2049359460,-2028631531))'</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
<div class="section level4">
<h4 id="ca-signed-certificates">CA Signed Certificates<a class="anchor" aria-label="anchor" href="#ca-signed-certificates"></a>
</h4>
<p>As an alternative to the zero-configuration default, a certificate
may also be generated via a Certificate Signing Request (CSR) to a
Certificate Authority (CA). The CA may be a public CA or internal to an
organisation.</p>
<ol style="list-style-type: decimal">
<li>Generate a private key and CSR. The following resources describe how
to do so:</li>
</ol>
<ul>
<li>using Mbed TLS: <a href="https://mbed-tls.readthedocs.io/en/latest/kb/how-to/generate-a-certificate-request-csr/" class="external-link uri">https://mbed-tls.readthedocs.io/en/latest/kb/how-to/generate-a-certificate-request-csr/</a>
</li>
<li>using OpenSSL: <a href="https://www.feistyduck.com/library/openssl-cookbook/online/" class="external-link uri">https://www.feistyduck.com/library/openssl-cookbook/online/</a>
(Chapter 1.2 Key and Certificate Management)</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Provide the generated CSR to the CA for it to sign a new TLS
certificate.</li>
</ol>
<ul>
<li>The common name (CN) of the certificate must be identical to the
hostname or IP address actually used for the connection. As this is
verified, it will fail if not the same.</li>
<li>The received certificate should comprise a block of cipher text
between the markers <code>-----BEGIN CERTIFICATE-----</code> and
<code>-----END CERTIFICATE-----</code>. Make sure to request the
certificate in the PEM format. If only available in other formats, the
TLS library used should usually provide conversion utilities.</li>
<li>Check also that the private key is a block of cipher text between
the markers <code>-----BEGIN PRIVATE KEY-----</code> and
<code>-----END PRIVATE KEY-----</code>.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>When setting daemons, the TLS certificate and private key should be
provided to the ‘tls’ argument of <code><a href="../reference/daemons.html">daemons()</a></code>.</li>
</ol>
<ul>
<li>If the certificate and private key have been imported as character
strings <code>cert</code> and <code>key</code> respectively, then the
‘tls’ argument may be specified as the character vector
<code>c(cert, key)</code>.</li>
<li>Alternatively, the certificate may be copied to a new text file,
with the private key appended, in which case the path/filename of this
file may be provided to the ‘tls’ argument.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>When launching daemons, the certificate chain to the CA should be
supplied to the ‘tls’ argument of <code><a href="../reference/daemon.html">daemon()</a></code> or
<code><a href="../reference/launch_local.html">launch_remote()</a></code>.</li>
</ol>
<ul>
<li>The certificate chain should comprise multiple certificates, each
between <code>-----BEGIN CERTIFICATE-----</code> and
<code>-----END CERTIFICATE-----</code> markers. The first one should be
the newly-generated TLS certificate, the same supplied to
<code><a href="../reference/daemons.html">daemons()</a></code>, and the final one should be a CA root
certificate.</li>
<li>These are the only certificates required if the certificate was
signed directly by a CA. If not, then the intermediate certificates
should be included in a certificate chain that starts with the TLS
certificate and ends with the certificate of the CA.</li>
<li>If these are concatenated together as a single character string
<code>certchain</code>, then the character vector comprising this and an
empty character string <code>c(certchain, "")</code> may be supplied to
the relevant ‘tls’ argument.</li>
<li>Alternatively, if these are written to a file (and the file
replicated on the remote machines), then the ‘tls’ argument may also be
specified as a path/filename (assuming these are the same on each
machine).</li>
</ul>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
</div>
<div class="section level3">
<h3 id="compute-profiles">Compute Profiles<a class="anchor" aria-label="anchor" href="#compute-profiles"></a>
</h3>
<p>The <code><a href="../reference/daemons.html">daemons()</a></code> interface also allows the specification of
compute profiles for managing tasks with heterogeneous compute
requirements:</p>
<ul>
<li>send tasks to different daemons or clusters of daemons with the
appropriate specifications (in terms of CPUs / memory / GPU /
accelerators etc.)</li>
<li>split tasks between local and remote computation</li>
</ul>
<p>Simply specify the argument <code>.compute</code> with a character
profile name (which, if <code>NULL</code>, is ‘default’). The daemons
settings are saved under the named profile.</p>
<p>To create a ‘mirai’ task using a specific compute profile, specify
the ‘.compute’ argument to <code><a href="../reference/mirai.html">mirai()</a></code>, which uses the
‘default’ compute profile if this is <code>NULL</code>.</p>
<p>Similarly, functions such as <code><a href="../reference/status.html">status()</a></code>,
<code><a href="../reference/launch_local.html">launch_local()</a></code> or <code><a href="../reference/launch_local.html">launch_remote()</a></code> should be
specified with the desired ‘.compute’ argument.</p>
<p><a href="#table-of-contents">« Back to ToC</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Charlie Gao, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

  </div></footer>
</body>
</html>
