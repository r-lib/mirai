<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Serialization - Arrow, ADBC, polars, torch • mirai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Serialization - Arrow, ADBC, polars, torch">
<script defer data-domain="mirai.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mirai</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mirai.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01-map.html">Mirai Map</a></li>
    <li><a class="dropdown-item" href="../articles/v02-promises.html">Promises - Shiny and Plumber</a></li>
    <li><a class="dropdown-item" href="../articles/v03-serialization.html">Serialization - Arrow, ADBC, polars, torch</a></li>
    <li><a class="dropdown-item" href="../articles/v04-parallel.html">Communications Backend for R</a></li>
    <li><a class="dropdown-item" href="../articles/v05-packages.html">For Package Authors</a></li>
    <li><a class="dropdown-item" href="../articles/v06-questions.html">Community FAQs</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://shikokuchuo.net/posts/27-mirai-240/">mirai 2.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://shikokuchuo.net/posts/26-mirai-230/">mirai 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://shikokuchuo.net/posts/25-mirai-v2/">mirai 2.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/mirai/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Serialization - Arrow, ADBC, polars, torch</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/mirai/blob/release/vignettes/v03-serialization.Rmd" class="external-link"><code>vignettes/v03-serialization.Rmd</code></a></small>
      <div class="d-none name"><code>v03-serialization.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="serialization-arrow-polars-and-beyond">1. Serialization: Arrow, polars and beyond<a class="anchor" aria-label="anchor" href="#serialization-arrow-polars-and-beyond"></a>
</h3>
<p>Native R serialization is used for sending data between host and
daemons. Some R objects by their nature cannot be serialized, such as
those accessed via an external pointer. In these cases, performing mirai
operations on them would normally error.</p>
<p>Using the <a href="https://arrow.apache.org/docs/r/" class="external-link"><code>arrow</code></a> package
as an example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">as_arrow_table</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; 'miraiError' chr Error: Invalid &lt;Table&gt;, external pointer to null</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>However, <code><a href="../reference/serial_config.html">serial_config()</a></code> can be used to create custom
serialization configurations, specifying functions that hook into R’s
native serialization mechanism for reference objects (‘refhooks’).</p>
<p>This configuration may then be passed to the ‘serial’ argument of a
<code><a href="../reference/daemons.html">daemons()</a></code> call.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  <span class="st">"ArrowTabular"</span>,</span>
<span>  <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 6 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;dictionary&lt;values=string, indices=int8&gt;&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; See $metadata for additional Schema metadata</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "some text"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>It can be seen that this time, the arrow table is handled seamlessly.
This is the case even when the object is deeply nested inside lists or
other structures.</p>
<p>Multiple serialization functions may be registered to handle
different object classes. As an example, we can use Arrow in combination
with <a href="https://pola-rs.github.io/r-polars/" class="external-link"><code>polars</code></a>, a
‘lightning fast’ dataframe library written in Rust (requires
<code>polars</code> &gt;= 0.16.4), in the following way:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  serial <span class="op">=</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ArrowTabular"</span>, <span class="st">"RPolarsDataFrame"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">polars</span><span class="fu">::</span><span class="fu">as_polars_df</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="fu">to_raw_ipc</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="fu">polars</span><span class="fu">::</span><span class="va">pl</span><span class="op">$</span><span class="va">read_ipc</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">polars</span><span class="fu">::</span><span class="fu">as_polars_df</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, b <span class="op">=</span> <span class="st">"some text"</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; shape: (6, 5)</span></span>
<span><span class="co">#&gt; ┌──────────────┬─────────────┬──────────────┬─────────────┬─────────┐</span></span>
<span><span class="co">#&gt; │ Sepal.Length ┆ Sepal.Width ┆ Petal.Length ┆ Petal.Width ┆ Species │</span></span>
<span><span class="co">#&gt; │ ---          ┆ ---         ┆ ---          ┆ ---         ┆ ---     │</span></span>
<span><span class="co">#&gt; │ f64          ┆ f64         ┆ f64          ┆ f64         ┆ cat     │</span></span>
<span><span class="co">#&gt; ╞══════════════╪═════════════╪══════════════╪═════════════╪═════════╡</span></span>
<span><span class="co">#&gt; │ 5.1          ┆ 3.5         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.9          ┆ 3.0         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.7          ┆ 3.2         ┆ 1.3          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 4.6          ┆ 3.1         ┆ 1.5          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 5.0          ┆ 3.6         ┆ 1.4          ┆ 0.2         ┆ setosa  │</span></span>
<span><span class="co">#&gt; │ 5.4          ┆ 3.9         ┆ 1.7          ┆ 0.4         ┆ setosa  │</span></span>
<span><span class="co">#&gt; └──────────────┴─────────────┴──────────────┴─────────────┴─────────┘</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] "some text"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="serialization-torch">2. Serialization: Torch<a class="anchor" aria-label="anchor" href="#serialization-torch"></a>
</h3>
<p>Tensors from the <a href="https://torch.mlverse.org/" class="external-link"><code>torch</code></a> package may be
used seamlessly in mirai computations.</p>
<p>Setup Steps:</p>
<ol style="list-style-type: decimal">
<li>Create the serialization configuration, specifying ‘class’ as
‘torch_tensor’.</li>
<li>Set up daemons, supplying the configuration to the ‘serial’
argument.</li>
<li>(Optional) Use <code><a href="../reference/everywhere.html">everywhere()</a></code> to make the
<code>torch</code> package available on all daemons for
convenience.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"torch_tensor"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va">torch_serialize</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va">torch_load</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Example Usage:</p>
<p>The below example creates a convolutional neural network using
<code>torch::nn_module()</code>.</p>
<p>A set of model parameters is also specified.</p>
<p>The model specification and parameters are then passed to and
initialized within a parallel process.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">nn_module</span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv1</span> <span class="op">&lt;-</span> <span class="fu">nn_conv2d</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv2</span> <span class="op">&lt;-</span> <span class="fu">nn_conv2d</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">nnf_relu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">nnf_relu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>in_size <span class="op">=</span> <span class="fl">1</span>, out_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span><span class="op">)</span>, model <span class="op">=</span> <span class="va">model</span>, params <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; An `nn_module` containing 1,040 parameters.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Modules ────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • conv1: &lt;nn_conv2d&gt; #520 parameters</span></span>
<span><span class="co">#&gt; • conv2: &lt;nn_conv2d&gt; #520 parameters</span></span></code></pre></div>
<p>The returned model is an object containing many tensor elements.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">conv1.weight</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; (1,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.0749 -0.1770  0.1144  0.0556  0.0455</span></span>
<span><span class="co">#&gt;   0.0785 -0.1295  0.0139 -0.0754  0.0812</span></span>
<span><span class="co">#&gt;  -0.0612 -0.0092  0.1769  0.0133 -0.1885</span></span>
<span><span class="co">#&gt;   0.1001  0.1398 -0.0314 -0.0528 -0.0436</span></span>
<span><span class="co">#&gt;  -0.0696 -0.1872 -0.1604  0.0281  0.0350</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (2,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.1088  0.0795  0.0859  0.1022 -0.1603</span></span>
<span><span class="co">#&gt;  -0.1867  0.0720 -0.1304 -0.1380  0.1889</span></span>
<span><span class="co">#&gt;   0.0529 -0.0230  0.0702 -0.0014 -0.0511</span></span>
<span><span class="co">#&gt;  -0.0224  0.0065  0.0108 -0.0455  0.0442</span></span>
<span><span class="co">#&gt;   0.0455  0.0641  0.0429 -0.0660 -0.0283</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (3,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.1508  0.1257 -0.0118  0.1994  0.1525</span></span>
<span><span class="co">#&gt;  -0.0877 -0.0659  0.1862 -0.0205  0.1314</span></span>
<span><span class="co">#&gt;   0.0674 -0.0554  0.1397 -0.1026 -0.0433</span></span>
<span><span class="co">#&gt;  -0.1998  0.1090 -0.0288  0.0015  0.1272</span></span>
<span><span class="co">#&gt;  -0.0879 -0.0436  0.0435 -0.0061 -0.0218</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (4,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.1629  0.0172 -0.0721  0.1160 -0.1692</span></span>
<span><span class="co">#&gt;   0.0489 -0.0214  0.1613  0.1808  0.0268</span></span>
<span><span class="co">#&gt;  -0.0446 -0.1501  0.0983  0.0154  0.1968</span></span>
<span><span class="co">#&gt;   0.1489 -0.1057  0.0011 -0.0853 -0.0962</span></span>
<span><span class="co">#&gt;   0.1582  0.0314 -0.1106 -0.1843  0.1558</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (5,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.1799 -0.0279 -0.1179  0.1431 -0.0512</span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{20,1,5,5} ][ requires_grad = TRUE ]</span></span></code></pre></div>
<p>It is usual for model parameters to then be passed to an
optimizer.</p>
<p>This can also be initialized within a parallel process.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">optim_rmsprop</span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span><span class="op">)</span>, params <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optim</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;optim_rmsprop&gt;</span></span>
<span><span class="co">#&gt;   Inherits from: &lt;torch_optimizer&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     add_param_group: function (param_group) </span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     defaults: list</span></span>
<span><span class="co">#&gt;     initialize: function (params, lr = 0.01, alpha = 0.99, eps = 1e-08, weight_decay = 0, </span></span>
<span><span class="co">#&gt;     load_state_dict: function (state_dict, ..., .refer_to_state_dict = FALSE) </span></span>
<span><span class="co">#&gt;     param_groups: list</span></span>
<span><span class="co">#&gt;     state: State, R6</span></span>
<span><span class="co">#&gt;     state_dict: function () </span></span>
<span><span class="co">#&gt;     step: function (closure = NULL) </span></span>
<span><span class="co">#&gt;     zero_grad: function (set_to_none = FALSE) </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     deep_clone: function (name, value) </span></span>
<span><span class="co">#&gt;     step_helper: function (closure, loop_fun)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Above, tensors and complex objects containing tensors were passed
seamlessly between host and daemon processes, in the same way as any
other R object.</p>
<p>The custom serialization in mirai leverages R’s own native ‘refhook’
mechanism to allow completely transparent usage. Designed to be fast and
efficient, data copies are minimized and the ‘official’ serialization
methods from the <code>torch</code> package are used directly.</p>
</div>
<div class="section level3">
<h3 id="database-hosting-using-arrow-database-connectivity">3. Database Hosting using Arrow Database Connectivity<a class="anchor" aria-label="anchor" href="#database-hosting-using-arrow-database-connectivity"></a>
</h3>
<p>It is possible using the <code>DBI</code> interface to access and
manipulate data in the Apache Arrow data format efficiently through ABDC
(Arrow Database Connectivity).</p>
<p>The example below creates an in-memory SQLite connection using the
<code>adbcsqlite</code> backend.</p>
<p>Serialization is set up with the relevant serialization functions
from the <code>arrow</code> package as part of the
<code><a href="../reference/daemons.html">daemons()</a></code> call. Note that the specified class is
‘nanoarrow_array_stream’ as <code>nanoarrow</code> is the backend for
all queries made by the DBI <code>db*Arrow()</code> functions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"nanoarrow_array_stream"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu">read_ipc_stream</span><span class="op">(</span><span class="va">x</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span>, serial <span class="op">=</span> <span class="va">cfg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span> <span class="co"># `adbi` and `adbcsqlite` packages must also be installed</span></span>
<span>    <span class="va">con</span> <span class="op">&lt;&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">adbi</span><span class="fu">::</span><span class="fu">adbi</span><span class="op">(</span><span class="st">"adbcsqlite"</span><span class="op">)</span>, uri <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/mirai.html">mirai()</a></code> calls may then be used to write to or query the
database all in the Arrow format.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">dbWriteTableArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span>, <span class="va">iris</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">dbReadTableArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 150 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;string&gt;</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Sepal.Length" &lt; 4.6'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 5 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;string&gt;</span></span></code></pre></div>
<p>Due to the tight integration of the mirai serialization mechanism
with R’s ‘refhook’ system, we can easily return complex / nested objects
containing multiple queries in the Arrow format:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Sepal.Length" &lt; 4.6'</span><span class="op">)</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Sepal.Width" &lt; 2.6'</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Petal.Length" &lt; 1.5'</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">dbGetQueryArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">'SELECT * FROM iris WHERE "Petal.Width" &lt; 0.2'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sepal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">a</span>, width <span class="op">=</span> <span class="va">b</span><span class="op">)</span>, petal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">x</span>, width <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">m</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="co">#&gt; $sepal</span></span>
<span><span class="co">#&gt; $sepal$length</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 5 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;string&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sepal$width</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 19 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;string&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $petal</span></span>
<span><span class="co">#&gt; $petal$length</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 24 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;string&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $petal$width</span></span>
<span><span class="co">#&gt; Table</span></span>
<span><span class="co">#&gt; 5 rows x 5 columns</span></span>
<span><span class="co">#&gt; $Sepal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Sepal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Length &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Petal.Width &lt;double&gt;</span></span>
<span><span class="co">#&gt; $Species &lt;string&gt;</span></span></code></pre></div>
<p>As before, <code><a href="../reference/everywhere.html">everywhere()</a></code> can be used to cleanly tear down
the databases, prior to resetting daemons.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="shiny-mirai-dbi-adbc-integrated-example">4. Shiny / mirai / DBI / ADBC Integrated Example<a class="anchor" aria-label="anchor" href="#shiny-mirai-dbi-adbc-integrated-example"></a>
</h3>
<p>The following is an example of how database connections hosted in
mirai daemons may be used to power a Shiny app.</p>
<p>The one-time <code>serialization()</code> setup ensures seamless
transport of Apache Arrow data, and occurs in the global environment
outside of <code>server()</code>.</p>
<p>A new database connection is created in a new daemon process for
every new Shiny session. The resources are freed when a sesssion ends.
This logic is all defined within <code>server()</code>. A unique ID is
used to identify each session, and is specified as the ‘compute profile’
for daemons.</p>
<p>Non-dispatcher daemons are created as scheduling is not required (all
queries expected to take roughly the same time, and in this case each
session uses only one daemon anyway).</p>
<p>Shiny ExtendedTask is then used to perform each query via a
<code><a href="../reference/mirai.html">mirai()</a></code> call, using the session-specific compute
profile.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mirai.r-lib.org">mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shikokuchuo.net/secretbase/" class="external-link">secretbase</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/bslib/" class="external-link">bslib</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create an Arrow serialization configuration</span></span>
<span><span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serial_config.html">serial_config</a></span><span class="op">(</span></span>
<span>  class <span class="op">=</span> <span class="st">"nanoarrow_array_stream"</span>,</span>
<span>  sfunc <span class="op">=</span> <span class="fu">arrow</span><span class="fu">::</span><span class="va">write_to_raw</span>,</span>
<span>  ufunc <span class="op">=</span> <span class="fu">nanoarrow</span><span class="fu">::</span><span class="va">read_nanoarrow</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># write 'iris' dataset to temp database file (for this demonstration)</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">adbi</span><span class="fu">::</span><span class="fu">adbi</span><span class="op">(</span><span class="st">"adbcsqlite"</span><span class="op">)</span>, uri <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbWriteTableArrow</span><span class="op">(</span><span class="va">con</span>, <span class="st">"iris"</span>, <span class="va">iris</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># common input parameters</span></span>
<span><span class="va">slmin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span></span>
<span><span class="va">slmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/page.html" class="external-link">page_fluid</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span><span class="st">"The time is "</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html" class="external-link">textOutput</a></span><span class="op">(</span><span class="st">"current_time"</span>, inline <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">hr</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">h3</a></span><span class="op">(</span><span class="st">"Shiny / mirai / DBI / ADBC demonstration"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html" class="external-link">p</a></span><span class="op">(</span><span class="st">"New daemon-hosted database connection is created for every Shiny session"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html" class="external-link">sliderInput</a></span><span class="op">(</span></span>
<span>    <span class="st">"sl"</span>, <span class="st">"Query iris dataset based on Sepal Length"</span>, min <span class="op">=</span> <span class="va">slmin</span>, max <span class="op">=</span> <span class="va">slmax</span>,</span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">slmin</span>, <span class="va">slmax</span><span class="op">)</span>, width <span class="op">=</span> <span class="st">"75%"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rstudio.github.io/bslib/reference/input_task_button.html" class="external-link">input_task_button</a></span><span class="op">(</span><span class="st">"btn"</span>, <span class="st">"Return query"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html" class="external-link">tableOutput</a></span><span class="op">(</span><span class="st">"table"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># uses Shiny ExtendedTask with mirai</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># create unique session id by hashing current time with a random key</span></span>
<span>  <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu">secretbase</span><span class="fu">::</span><span class="fu">siphash13</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, key <span class="op">=</span> <span class="fu">nanonext</span><span class="fu">::</span><span class="fu"><a href="https://nanonext.r-lib.org/reference/random.html" class="external-link">random</a></span><span class="op">(</span><span class="fl">4L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># create new daemon for each session</span></span>
<span>  <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1L</span>, serial <span class="op">=</span> <span class="va">cfg</span>, .compute <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># tear down daemon when session ends</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="fu">onEnded</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0L</span>, .compute <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># everywhere() loads DBI and creates ADBC connection in each daemon</span></span>
<span>  <span class="co"># and sets up serialization</span></span>
<span>  <span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span> <span class="co"># `adbi` and `adbcsqlite` packages must also be installed</span></span>
<span>      <span class="va">con</span> <span class="op">&lt;&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu">adbi</span><span class="fu">::</span><span class="fu">adbi</span><span class="op">(</span><span class="st">"adbcsqlite"</span><span class="op">)</span>, uri <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    file <span class="op">=</span> <span class="va">file</span>,</span>
<span>    .compute <span class="op">=</span> <span class="va">id</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html" class="external-link">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/invalidateLater.html" class="external-link">invalidateLater</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%H:%M:%S %p"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">task</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/shiny/man/ExtendedTask.html" class="external-link">ExtendedTask</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span></span>
<span>      <span class="fu">dbGetQueryArrow</span><span class="op">(</span></span>
<span>        <span class="va">con</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>          <span class="st">"SELECT * FROM iris WHERE \"Sepal.Length\" BETWEEN %.2f AND %.2f"</span>,</span>
<span>          <span class="va">sl</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span>,</span>
<span>          <span class="va">sl</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="va">...</span>,</span>
<span>      .compute <span class="op">=</span> <span class="va">id</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rstudio.github.io/bslib/reference/bind_task_button.html" class="external-link">bind_task_button</a></span><span class="op">(</span><span class="st">"btn"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">btn</span>, <span class="va">task</span><span class="op">$</span><span class="fu">invoke</span><span class="op">(</span>sl <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">sl</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html" class="external-link">renderTable</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">result</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># run Shiny app</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html" class="external-link">shinyApp</a></span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># deletes temp database file (for this demonstration)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Charlie Gao, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
